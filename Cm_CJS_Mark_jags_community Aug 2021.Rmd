---
title: "Capture mark recapture analysis of green turtles"
author: "Tomo Eguchi"
date: "4/1/2021"
output: word_document
---

```{r setup, include=FALSE, echo=FALSE}
rm(list=ls())

knitr::opts_chunk$set(echo = TRUE)

library(jagsUI)
library(tidyverse)
library(lubridate)
library(reshape)
library(bayesplot)
library(ggridges)
library(RMark)
library(R2ucare)
library(loo)

source("Mancini_functions.R")
save.fig <- F
fig.height <- 4
fig.width <- 6

# a function to replace parentheses with brackets
# With parentheses, table entries are read as TeX, resulting in subscripts
# With brackets, they are all read as characters - must be a better way to
# deal with this stuff but couldn't find one 2021-01-08
paren2bracket <- function(df.in){
  tmp <- gsub("(", "[", df.in, fixed = T)
  tmp <- gsub(")", "]", tmp, fixed = T)
  return(tmp)
}

# tilde12dot <- function(df.in){
#   tmp <- gsub("~1", ".", df.in, fixed = T)
#   return(tmp)
# }

```

## Methods

To estimate survival rate and abundance of green turtles, Cormack-Jolly-Seber (CJS) models were fitted to the capture-recapture dataset for green turtles. Results indicated that apparent changes in abundance might have been caused by sampling inequalities among study sites. In order to remove the inequalities, CJS models were fitted to data from each study site independently. This was justified by the lack of movements by turtles among the study sites. 

Briefly, the CJS model uses the capture history of each individual without assuming that the population is closed. There are two main parameters in the basic model; survival rate (phi) and capture/recapture probability (p).  The abundance may be estimated through the Horvitz-Thompson estimator, where the number of captured individuals per sampling period is divided by the estimated capture probability for that time period. The estimated survival rate should be considered as an apparent survival rate as the permanent emigrant is considered as dead.  Effects of transients, however, can be determined.   

The basic model can be extended to accommodate various modifications, such as time-dependent survival rates, time-dependent capture probability, covariate-dependent survival rates and capture probabilities.

Communities with small proportions (< 0.05) of recaptures, i.e., the number of individuals caught more than once in the total number of individuals, were excluded from the analysis because of insufficient numbers of recaptures. 
Capture history data from each study area with sufficient numbers of recaptures were pooled by sampling seasons (summer and winter). In other words, multiple captures within each season were treated as one capture. 

I considered several possible CJS models for this analysis. For survival rates, they were treated as either constant or affected by transients (time-since-marking; TSM). For capture probabilities, they were treated as either constant, time dependent, different between the first and subsequent captures (trap response), different between summer and winter, or a function of effort. A total of 14 models were fitted to the data (Table 1).

I decided not to use individual covariates because there were many unobserved (295 NAs for SCL).

Capture-recapture data of green turtles were separated into study areas and CJS models were fitted using Mark (White and Cooch Yr) via RMark (v. ```r packageVersion("RMark")```, Laake 2013, Laake, J.L. (2013). RMark: An R Interface for Analysis of Capture-Recapture Data with MARK. AFSC Processed Rep 2013-01, 25p. Alaska Fish. Sci. Cent., NOAA, Natl. Mar. Fish. Serv., 7600 Sand Point Way NE, Seattle WA 98115.). Some capture events in the beginning of a few time series were deleted because of the small numbers of captures. For each location, fit of various models were compared using AICc. Parameters estimates from the model with the smallest AICc value are reported. 

The best models for each location were also fitted using the Bayesian equivalent  (Kery an Schaub 2012; Bayesian population analysis using WinBUGS. Academic Press, Elsevier, Waltham MA, USA) using JAGS (v. 4.x.x, Plummer 20??) via the jagsUI package (v. ```r packageVersion("jagsUI")```, Kellner 2019, Ken Kellner (2019). jagsUI: A Wrapper Around 'rjags' to Streamline 'JAGS' Analyses. R package version 1.5.1. https://CRAN.R-project.org/package=jagsUI) in R (v 4.0.2, R Core Team). At some locations, Bayesian parameter estimates from the best model appeared to be "wanky." Consequently, I used the second best model for those locations. In the Bayesian approach, the hierarchical models allowed me to include all sampling periods, unlike the maximum likelihood approach. To make a comparison between the maximum likelihood and Bayesian approaches, I used the same input data for the ML and Bayesian analyses. I also analyzed the entire data from each location with the Bayesian approach. 

Abundance was estimated using the Horvitz-Thompson estimator. 

```{r data, echo=FALSE, include=T}

dat.1.Cm <- get.data.Cm("data/GTC_Cm Data_updated_2020-04-28_TE_v2.csv")

# Group by community and create CJS data for each community
community.names <- levels(as.factor(dat.1.Cm$community))
```


```{r RMark, echo=FALSE, include=T}
# Analyses were completed in Cm_CJS_v3_Mark_community.Rmd
# some communities don't have enough recaptures to do CMR modeling
c <- 0
k <- 18
p.recap <- vector(mode = "numeric")
community.names.used <- vector(mode = "character")
Cm.results <- Cm.CJS.input <- vector(mode = "list")

for (k in 1:length(community.names)){
    dat.1.Cm.community <- filter(dat.1.Cm, community == community.names[k])
    CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
    n.GT2.cap <- length(which(rowSums(CJS.data$data) > 1))
    p.recap[k] <- n.GT2.cap/nrow(CJS.data$data)

    if (p.recap[k] > 0.05){
      community.names.used[c + 1] <- community.names[k]
    }
    
  if (file.exists(paste0("RData/CJS_Cm_RMark_", community.names[k], ".rds"))){
    Cm.results[[c+1]] <- readRDS(file = paste0("RData/CJS_Cm_RMark_", 
                                               community.names[k], ".rds"))
    Cm.CJS.input[[c+1]] <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", 
                                                 community.names[k], ".rds"))
      c <- c + 1
  } 
  
}

mark.table <- model.table(Cm.results[[1]]) %>% rownames_to_column(var = "ID")
# 

```

```{r model_defs, echo=F, include=T}

# tmp <- gsub("(", "[", mark.table$model, fixed = T)
# tmp <- gsub(")", "]", tmp, fixed = T)
mark.table$Model <- paren2bracket(mark.table$model) #%>% tilde12dot()

knitr::kable(mark.table %>% select(ID, Model) %>% arrange(by = as.numeric(ID)), 
             digits = 2,
             caption = "Table 1. Definitions of 14 CJS models fitted to CMR data of green turtles. '~1' indicates a constant.",
             table.attr = "style='width:30%;'")
```

## Results
Of ```r length(community.names)``` communities, only ```r length(community.names.used)``` communities contained sufficient recaptures. Data for  ```r length(community.names) - length(community.names.used)```  communities were not used in the following analysis. Goodness of fit of CJS models was examined for each study area. Results from each community are provided separately in the following sections.

### Goodness of fit

These results should be in a supplementary material. 

```{r GOF, echo=F, include=F, cache=T, warning=F}

overall_Cm <- test3sr_Cm <- test3sm_Cm <- test2ct_Cm <- test2cl_Cm <- vector(mode = "list")

for (k in 1:length(community.names.used)){
  output.filename <- paste0("RData/CJS_Cm_RMark_input_", community.names.used[k], ".rds")
  
  results.k <- readRDS(file = output.filename)
  #CH.Ucare <-R2ucare::group_data(CJS.data$data, effX = rep(1, nrow(CJS.data$data)))
  CH.Ucare <- results.k$CH.R2ucare
  
  overall_Cm[[k]] <- list(community = community.names.used[k],
                          test.out = overall_CJS(as.matrix(CH.Ucare[, 1:(ncol(CH.Ucare)-1)]), 
                                                 freq = CH.Ucare$effY)) 
  
  test3sr_Cm[[k]] <- list(community = community.names.used[k],
                          test.out = test3sr(as.matrix(CH.Ucare[, 1:(ncol(CH.Ucare)-1)]), 
                                             freq = CH.Ucare$effY)) 
  
  test3sm_Cm[[k]] <- list(community = community.names.used[k],
                          test.out = test3sm(as.matrix(CH.Ucare[, 1:(ncol(CH.Ucare)-1)]), 
                                             freq = CH.Ucare$effY))
  
  test2ct_Cm[[k]] <- list(community = community.names.used[k],
                          test.out = test2ct(as.matrix(CH.Ucare[, 1:(ncol(CH.Ucare)-1)]), 
                                             freq = CH.Ucare$effY))
  
  test2cl_Cm[[k]] <- list(community = community.names.used[k],
                          test.out = test2cl(as.matrix(CH.Ucare[, 1:(ncol(CH.Ucare)-1)]), 
                                             freq = CH.Ucare$effY))
}


overall.GOF <- lapply(overall_Cm, 
                      FUN = function(x) out.list <- list(community  = x$community, 
                                                         Chi2 = x$test.out$chi2,
                                                         df = x$test.out$degree_of_freedom,
                                                         p_val = x$test.out$p_value,
                                                         c_hat = signif(x$test.out$chi2/x$test.out$degree_of_freedom, 3)))

overall.GOF.df <- data.frame(do.call(rbind, overall.GOF))

```

#### Overall test

```{r table_overall_GOF, echo=F, include=T}
knitr::kable(overall.GOF.df, 
             digits = 2,
             col.names = c("Community", "Chi2", "df", "p val", "c-hat"),
             caption = "Table 2. Results from overall goodness-of fit",
             table.attr = "style='width:30%;'")
```

#### TEST3.SR
TEST3.SR asks "of those individuals seen either on or before occasion (i), what proportion were ever seen again?" According to the Book (Mark Book), it states that "If TEST3.SR is rejected, then this suggests that there is a difference in 'survival' among individuals, depending on whether or not they were seen for the first time either on or before occasion (i)." 

```{r test3sr, echo=FALSE, include=T}
test3sr.overall <- lapply(test3sr_Cm, 
                         FUN = function(x){out.list <- list(community  = x$community, 
                                                            stat = unname(x$test.out$test3sr["stat"]),
                                                            df = unname(x$test.out$test3sr["df"]),
                                                            p_val = unname(x$test.out$test3sr["p_val"]),
                                                            sign_test = unname(x$test.out$test3sr["sign_test"]))
                         return(out.list)})

test3sr.overall.df <- data.frame(do.call(rbind, test3sr.overall))
```


```{r table_test3sr, echo=F, include=T}
knitr::kable(test3sr.overall.df, 
             digits = 2,
             col.names = c("Community", "Stat", "df", "p val", "signed test"),
             caption = "Table 3. Results from Test3.sr, which evaluates difference in the expected time of first recapture between the ‘new’ and ‘old’ individuals captured at occasion i and seen again at least once",
             table.attr = "style='width:30%;'")
```

#### TES3.Sm

TEST3.Sm tests the hypothesis that there is no difference in the expected time of first recapture between the ‘new’ and ‘old’ individuals captured at occasion i and seen again at least once. It looks at individuals who were seen again. "Among these individuals seen again, when they were seen again does not depend on whether or not they were seen for the first time at occasion (i)."

```{r test3.sm, echo=F, include=F, cache=T}
test3sm.overall <- lapply(test3sm_Cm, 
                          FUN = function(x) out.list <- list(community  = x$community, 
                                                             stat =  unname(x$test.out$test3sm["stat"]),
                                                             df =  unname(x$test.out$test3sm["df"]),
                                                             p_val = unname(x$test.out$test3sm["p_val"])))


test3sm.overall.df <- data.frame(do.call(rbind, test3sm.overall))
```


```{r table_test3sm, echo=F, include=T}
knitr::kable(test3sm.overall.df, 
             digits = 2,
             col.names = c("Community", "Stat", "df", "p val"),
             caption = "Table 4. Results from Test3.sm, which evaluates difference in the expected time of first recapture between the ‘new’ and ‘old’ individuals captured at occasion i and seen again at least once",
             table.attr = "style='width:30%;'")
```

#### TEST2.CT

TEST2.CT tests the hypothesis that "there is no difference in the probability of being recaptured at t+1 between those captured and not captured at occasion t, conditional on presence at both occasions.  

```{r test2ct, echo=F, include=F}
test2ct.overall <- lapply(test2ct_Cm, 
                          FUN = function(x) out.list <- list(community  = x$community, 
                                                             stat =  unname(x$test.out$test2ct["stat"]),
                                                             df =  unname(x$test.out$test2ct["df"]),
                                                             p_val = unname(x$test.out$test2ct["p_val"]),
                                                             sign_test = unname(x$test.out$test2ct["sign_test"])))


test2ct.overall.df <- data.frame(do.call(rbind, test2ct.overall))
```


```{r table_test2ct, echo=F, include=T}
knitr::kable(test2ct.overall.df, 
             digits = 2,
             col.names = c("Community", "stat", "df", 
                           "p val", "signed test"),
             caption = "Table 5. Results from Test2.ct, which evaluates difference in the probability of being recaptured at t+1 between those captured and not captured at occasion t, conditional on presence at both occasions",
             table.attr = "style='width:30%;'")
```

#### TEST2.CL

TEST2.CL tests if there is no difference in the expected time of next capture between the individuals captured and not captured at occasion t conditional on presence at both occasions t and t + 2.  

```{r test2cl, echo=F, include=F, warning=F}
# The null hypothesis being tested in TEST2.CL is that there is no difference in
# the expected time of next recapture between the individuals captured and not captured at occasion i
# conditional on presence at both occasions i and i+2. To date, this test has no ‘simple’ interpretation, but
#it is a component test of the overall TEST2 fit statistic.
test2cl.overall <- lapply(test2cl_Cm, 
                          FUN = function(x) out.list <- list(community  = x$community, 
                                                             stat =  unname(x$test.out$test2cl["stat"]),
                                                             df =  unname(x$test.out$test2cl["df"]),
                                                             p_val = unname(x$test.out$test2cl["p_val"])))


test2cl.overall.df <- data.frame(do.call(rbind, test2cl.overall))
```


```{r table_test2cl, echo=F, include=T}
knitr::kable(test2cl.overall.df, 
             digits = 2,
             col.names = c("Community", "Stat", "df", "p val"),
             caption = "Table 6. Results from Test2.cl, which evaluates the expected time of next capture between the individuals captured and not captured at occasion t conditional on presence at both occasions t and t + 2",
             table.attr = "style='width:30%;'")
```

All tests indicate that almost all datasets passed the GOF tests. (except GNO, which resulted in some NAs... and PAO Test2.ct) - Look into these! 2020-12-10

For the following analyses, estimated capture probabilities that were less than 0.001 were considered unreliable and eliminated. 


### Demographic parameter estimates

```{r selected_models, echo=FALSE}
community.names <- c("BKS", "BMA", "GNO", 
                     "IES", "LSI", "MUL",
                     "PAO", "PLM")

# Because of absurdly small survival rate estimates for Phidot models, I changed them to 
# phiTSM models - they were the second best models for those communities
# BKS: Phidot_pt (2) -> PhiTSM_pt (11)
# LSI: Phidot_pt (2) -> PhiTSM_pt (11)
# MUL: Phidot_pdot (1) -> PhiTSM_pdot (10)
# PAO: Phidot_pt (2) -> PhiTSM_pt (11)
models.MARK <- data.frame(community = community.names,
                          ID = c(11, 10, 11,
                                 11, 11, 10,
                                 11, 11),
                          model = c("PhiTSM_pt", "PhiTSM_pdot", "PhiTSM_pt",
                                    "PhiTSM_pt", "PhiTSM_pt", "PhiTSM_pdot",
                                    "PhiTSM_pt", "PhiTSM_pt"))

# For GNO, Phi[TSM]p[t] resulted in near 1 survival rate estimate, so used the second best
# model, which was Phi[~1]p[t]
models.MARK.old <- data.frame(community = community.names,
                          ID = c(2, 10, 2,
                                 11, 2, 1,
                                 2, 11),
                          model = c("Phidot_pt", "PhiTSM_pdot", "Phidot_pt",
                                    "PhiTSM_pt", "Phidot_pt", "Phidot_pdot",
                                    "Phidot_pt", "PhiTSM_pt"))
```


#### BKS

```{r capture_history_BKS, echo=FALSE}
loc <- "BKS"
dat.1.Cm.community <- filter(dat.1.Cm, community == loc)
Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", loc, ".rds"))

CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
n.occ <- ncol(CJS.data$data)
n.caught <- colSums(CJS.data$data)

p.captures <- ggplot(dat.1.Cm.community) + 
  geom_point(aes(x = DATE,  y = ID)) +
  geom_path(aes(x = DATE, y = ID)) +
  theme(axis.text.y = element_blank())+
  labs(title = loc)

if (save.fig)
  ggsave(filename = paste0("figures/Cm_capture_history_", loc, ".png"),
         plot = p.captures, device = "png", dpi = 600,
         height = fig.height, width = fig.width)

n.caps <- rowSums(CJS.data$data) %>% 
  data.frame() %>% 
  rownames_to_column(var = "ID") 

colnames(n.caps) <- c("ID", "n")   # there has to be a better way but... 

p.n.captures <- ggplot(data = n.caps) + 
  geom_histogram(aes(x = n), binwidth = 1)

if (save.fig)
  ggsave(filename = paste0("figures/Cm_capture_histogram_", loc, ".png"),
         plot = p.n.captures, device = "png", dpi = 600,
         height = fig.height, width = fig.width)


```

At ```r loc```, there were ```r nrow(CJS.data$data)``` turtles in the dataset. However, the numbers of turtles caught per capture occasion before ```r Cm.inputs$first.sample.date``` were insufficient to include in CMR analyses and excluded. Consequently, the capture histories of ```r nrow(Cm.inputs$CH.1)``` individual turtles from ```r Cm.inputs$first.sample.date``` to ```r max(dat.1.Cm.community$DATE)``` were used in the analysis. There were ```r n.occ``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)```. The number of captures per individual ranged from ```r min(rowSums(CJS.data$data))``` to ```r max(rowSums(CJS.data$data))``` with the median of ```r median(rowSums(CJS.data$data))``` and the mean of ```r signif(mean(rowSums(CJS.data$data)), 2)``` (Figure x). 

```{r plot_Cap_His_BKS, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Capture histories of tagged green turtles at BKS. Each filled circle indicates a capture event and the same individuals are connected by lines."}
knitr::include_graphics(paste0("figures/Cm_capture_history_", loc, ".png"))
```


```{r plot_Cap_n_BKS, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. The number of times individual green turtles were captured at BKS. "}
knitr::include_graphics(paste0("figures/Cm_capture_histogram_", loc, ".png"))
```

##### Mark (Phi[.]p[t])
For this study area, the best model was a constant survival and time-dependent capture probabilities (phi[~1]p[time], Table 7). The second best model with $\delta$AICc = 1.45 (phi[TSM]p[time]) indicated survival may be a function of time-since-marking, which is an evidence of presence of transient animals.   

```{r model_comp_BKS, echo=F}
Cm.results.Mark <- readRDS(file = paste0("RData/CJS_Cm_RMark_", loc, ".rds"))

BKS.models.df <- model.table(Cm.results.Mark) %>% 
  select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model)) #%>% tilde12dot()
```


```{r table_models_BKS, echo=F, include=T}
knitr::kable(BKS.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = paste0("Table. Model comparison for community ", loc),
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_BKS, echo=F, include=F}

real.estimates <- Cm.results.Mark$Phi.dot.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

p.Nhats <- ggplot(data = N.Phi.p.hats.Mark$Nhats) +
  geom_point(aes(x = season, y = (Nhat))) +
  geom_errorbar(aes(x = season, ymin = (lcl2), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, ".png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


Using the best model, the survival rate was estimated to be ```r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"], 3)``` (SE = ```r signif(N.Phi.p.hats.Mark$Phihats[1, "se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats.Mark$Phihats[1, "lcl"], 2)``` - ```r signif(N.Phi.p.hats.Mark$Phihats[1, "ucl"], 2)```]). The wide confidence interval indicated that this estimate is not very reliable. 

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T),2)``` to ```r format(signif(max(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T), 5), big.mark = ",")``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x).


```{r plot_Nhats_BKS, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at BKS when the maximum likelihood approach and the Phi[~1]p[t] model were used to analyze the capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, ".png"))
```

##### Bayesian

###### Using the same data and model as Mark

```{r parameter_estimates_jags_v5_BKS, echo=F, include=F}
# v5 means that the same model and dataset as what Mark selected. 

N.Phi.hats.Jags <- stats.Bayesian_v5(models.MARK.old, loc)

p.Nhats <- ggplot(data = N.Phi.hats.Jags$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (```r models.MARK.old %>% filter(community == loc) %>% select(model)```), the estimated mean survival rate was ```r signif(N.Phi.hats.Jags$Phihats$mean, 3)``` (SD = ```r signif(N.Phi.hats.Jags$Phihats$sd, 3)```, 95% CI = [```r signif(N.Phi.hats.Jags$Phihats$lcl, 3)``` - ```r signif(N.Phi.hats.Jags$Phihats$ucl, 2)```]). These estimates are much less than those from Mark. I'm not sure what's happening here. They should be the same model. I looked for obvious errors, e.g., incorrect model files, model statements, etc. But, I did not find anything there. This needs to be investigated a bit more. 2021-08-16. 

I think the problem is the recapture rate is very small - the vast majority of turtles were caught just once. Does Mark drop those that were caught just once? It makes no sense to have such high survival rate if many were caught just once... 

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 3)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

```{r plot_Nhats_jags_v5_BKS, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at BKS when the Bayesian approach, the Phi[~1]p[t] model, and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```

###### Using the same data and Phi[TSM] model

```{r parameter_estimates_jags_v5_TSM_BKS, echo=F, include=F}
# v5 means that the same model and dataset as what Mark selected. 
N.Phi.hats.TSM.Jags <- stats.Bayesian_v5(models.MARK, loc)

p.Nhats <- ggplot(data = N.Phi.hats.TSM.Jags$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_v5_TSM.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```

Using the second best model (```r models.MARK %>% filter(community == loc) %>% select(model)```), the estimated mean survival rate of residents was ```r signif(N.Phi.hats.TSM.Jags$Gammahats[1, "mean"], 3)``` (SD = ```r signif(N.Phi.hats.TSM.Jags$Gammahats[1, "sd"], 3)```, 95% CI = [```r signif(N.Phi.hats.TSM.Jags$Gammahats[1, "lcl"], 3)``` - ```r signif(N.Phi.hats.TSM.Jags$Gammahats[1, "ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.hats.TSM.Jags$Gammahats[1, "mean"]/N.Phi.hats.TSM.Jags$Gammahats[2, "mean"], 3)``` using the two survival rate estimates (one for transients and residents and another for residents only).

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats.TSM.Jags$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats.TSM.Jags$Nhats$mean, na.rm = T), 3)```.   

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats.TSM.Jags$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats.TSM.Jags$Nhats$mean, na.rm = T), 3)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 


```{r plot_Nhats_jags_v5_TSM_BKS, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at BKS when the Bayesian approach, the Phi[TSM]p[t] model, and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5_TSM.png"))
```


```{r Nhats_comparison, echo=F, include=F}
#Abundance estimates between the two models were similar?
Nhats <- data.frame(N_mean_Phidot = N.Phi.hats.Jags$Nhats$mean,
                    N_median_Phidot = N.Phi.hats.Jags$Nhats$median,
                    N_lcl_Phidot = N.Phi.hats.Jags$Nhats$lcl,
                    N_ucl_Phidot = N.Phi.hats.Jags$Nhats$ucl,
                    N_mean_PhiTSM = N.Phi.hats.TSM.Jags$Nhats$mean,
                    N_median_PhiTSM = N.Phi.hats.TSM.Jags$Nhats$median,
                    N_lcl_PhiTSM = N.Phi.hats.TSM.Jags$Nhats$lcl,
                    N_ucl_PhiTSM = N.Phi.hats.TSM.Jags$Nhats$ucl)

p.Nhats.comparison <- ggplot(data = Nhats) +
  geom_point(aes(x = N_mean_Phidot, y = N_mean_PhiTSM)) +
  geom_errorbar(aes(x = N_mean_Phidot, ymin = N_lcl_PhiTSM, ymax = N_ucl_PhiTSM)) +
  geom_errorbarh(aes(y = N_mean_PhiTSM, xmin = N_lcl_Phidot, xmax = N_ucl_Phidot)) +
  geom_abline(slope = 1, intercept = 0)

#p.Nhats.comparison
```

```{r Nhats_comparison_median, include=F, echo=F}
p.Nhats.comparison.median <- ggplot(data = Nhats) +
  geom_point(aes(x = N_median_Phidot, y = N_median_PhiTSM)) +
  geom_errorbar(aes(x = N_median_Phidot, ymin = N_lcl_PhiTSM, ymax = N_ucl_PhiTSM)) +
  geom_errorbarh(aes(y = N_median_PhiTSM, xmin = N_lcl_Phidot, xmax = N_ucl_Phidot)) +
  geom_abline(slope = 1, intercept = 0)

#p.Nhats.comparison.median

```


They don't look so good. Probably not a good idea to provide estimates for this location. 

###### Using the entire data and Phi[TSM] model

```{r parameter_estimates_jags_BKS, echo=F, include=F}
#loc <- "BKS"
#models.MARK contains phiTSM as the best models, as opposed to models.MARK.old
N.Phi.hats.TSM.Jags <- stats.Bayesian(models.MARK, loc)

p.Nhats <- ggplot(data = N.Phi.hats.TSM.Jags$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "TSM_jags.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the Phi[TSM]p[t] model, the estimated mean survival rate of residents was ```r signif(N.Phi.hats.TSM.Jags$Gammahats[1, "mean"], 3)``` (SD = ```r signif(N.Phi.hats.TSM.Jags$Gammahats[1, "sd"], 3)```, 95% CI = [```r signif(N.Phi.hats.TSM.Jags$Gammahats[1, "lcl"], 3)``` - ```r signif(N.Phi.hats.TSM.Jags$Gammahats[1, "ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.hats.TSM.Jags$Gammahats[1, "mean"]/N.Phi.hats.TSM.Jags$Gammahats[2, "mean"], 3)``` using the two survival rate estimates (one for transients and residents and another for residents only).

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats.TSM.Jags$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats.TSM.Jags$Nhats$mean, na.rm = T), 3)```. 

```{r plot_Nhats_jags_BKS, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at BKS when the Bayesian approach, the entire dataset, and the Phi[TSM]p[t] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags.png"))
```

#### BMA

```{r capture_history_BMA, echo=FALSE}
loc <- "BMA"
dat.1.Cm.community <- filter(dat.1.Cm, community == loc)
CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", loc, ".rds"))

n.occ <- ncol(CJS.data$data)
n.caught <- colSums(CJS.data$data)

p.captures <- ggplot(dat.1.Cm.community) + 
  geom_point(aes(x = DATE,  y = ID)) +
  geom_path(aes(x = DATE, y = ID)) +
  theme(axis.text.y = element_blank()) +
  labs(title = loc)

if (save.fig)
  ggsave(filename = paste0("figures/Cm_capture_history_", loc, ".png"),
         plot = p.captures, device = "png", dpi = 600,
         height = fig.height, width = fig.width)

n.caps <- rowSums(CJS.data$data) %>% 
  data.frame() %>% 
  rownames_to_column(var = "ID") 

colnames(n.caps) <- c("ID", "n")   # there has to be a better way but... 

p.n.captures <- ggplot(data = n.caps) + 
  geom_histogram(aes(x = n), binwidth = 1)

if (save.fig)
  ggsave(filename = paste0("figures/Cm_capture_histogram_", loc, ".png"),
         plot = p.n.captures, device = "png", dpi = 600,
         height = fig.height, width = fig.width)

```

At ```r loc```, there were ```r nrow(CJS.data$data)``` turtles in the dataset. However, the numbers of turtles caught per capture occasion before ```r Cm.inputs$first.sample.date``` were insufficient to include in CMR analyses and excluded. Consequently, the capture histories of ```r nrow(Cm.inputs$CH.1)``` individual turtles from ```r Cm.inputs$first.sample.date``` to ```r max(dat.1.Cm.community$DATE)``` were used in the analysis. There were ```r n.occ``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)```. The number of captures per individual ranged from ```r min(rowSums(CJS.data$data))``` to ```r max(rowSums(CJS.data$data))``` with the median of ```r median(rowSums(CJS.data$data))``` and the mean of ```r signif(mean(rowSums(CJS.data$data)), 2)``` (Figure x). 

```{r plot_Cap_His_BMA, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Capture histories of tagged green turtles at BKS. Each filled circle indicates a capture event and the same individuals are connected by lines."}
knitr::include_graphics(paste0("figures/Cm_capture_history_", loc, ".png"))
```


```{r plot_Cap_n_BMA, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. The number of times individual green turtles were captured at BKS. "}
knitr::include_graphics(paste0("figures/Cm_capture_histogram_", loc, ".png"))
```

##### Mark
```{r model_comp_BMA, echo=F}
Cm.results.Mark <- readRDS(file = paste0("RData/CJS_Cm_RMark_", loc, ".rds"))

BMA.models.df <- model.table(Cm.results.Mark)%>% select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model)) #%>%tilde12dot()
```

Six models were within $\delta$AICc < 4, where all of them included Phi[TSM]. The best model was Phi[TSM]p[.] (Table). 

```{r table_models_BMA, echo=F, include=T, warning=FALSE, message=FALSE}
knitr::kable(BMA.models.df, 
             digits = 2,
             col.names = c("model", "deltaAICc"),
             row.names = F,
             caption = "Model comparison for community BMA",
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_BMA, echo=F}

real.estimates <- Cm.results.Mark$Phi.tsm.p.dot$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

# turn Nhats to NA when SE = 0 or SE > 1000
#Nhats.df[Nhats.df$SE_Nhat < 0.001 | Nhats.df$SE_Nhat > 1000, c("Nhat", "lcl", "ucl", "lcl2")] <- NA

p.Nhats <- ggplot(data = N.Phi.p.hats.Mark$Nhats) +
  geom_point(aes(x = season, y = (Nhat))) +
  geom_errorbar(aes(x = season, ymin = (lcl2), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = "BMA")

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, ".png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```

Using the best model, the survival rate of residents was estimated to be ```r signif(N.Phi.p.hats.Mark$Phihats[2,"estimate"], 3)``` (SE = ```r signif(N.Phi.p.hats.Mark$Phihats[2, "se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats.Mark$Phihats[2, "lcl"], 2)``` - ```r signif(N.Phi.p.hats.Mark$Phihats[2, "ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"]/N.Phi.p.hats.Mark$Phihats[2,"estimate"], 3)```, using the two survival rates (one for transients and residents and another for residents only). 

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T),2)``` to ```r format(signif(max(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T), 5), big.mark = ",")```.

```{r plot_Nhats_BMA, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at BMA when the maximum likelihood approach and the Phi[TSM]p[~1] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, ".png"))
```

##### Bayesian

###### Using the same data and model as Mark

```{r parameter_estimates_jags_v5_BMA, echo=F, include=F}
# v5 means the same data and model as what Mark selected
#loc <- "BMA"
N.Phi.hats.Jags <- stats.Bayesian_v5(models.MARK.old, loc)

p.Nhats <- ggplot(data = N.Phi.hats.Jags$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (```r models.MARK.old %>% filter(community == loc) %>% select(model)```), the estimated mean survival rate of residents was ```r signif(N.Phi.hats.Jags$Gammahats[1, "mean"], 3)``` (SD = ```r signif(N.Phi.hats.Jags$Gammahats[1, "sd"], 3)```, 95% CI = [```r signif(N.Phi.hats.Jags$Gammahats[1, "lcl"], 2)``` - ```r signif(N.Phi.hats.Jags$Gammahats[1, "ucl"], 2)```]). These estimates are similar to those from the maximum likelihood estimates. 

The proportion of residents was estimated to be ```r signif(N.Phi.hats.Jags$Gammahats[1,"mean"]/N.Phi.hats.Jags$Gammahats[2,"mean"], 3)```, using the two survival rates (one for transients and residents and another for residents only), which was higher than the estimate from the maximum likelihood approach (0.21). 

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 3)```. These estimates were also similar to those from the ML approach.  

```{r plot_Nhats_jags_v5_BMA, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at BKS when the Bayesian approach, the Phi[TSM]p[~1] model, and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```

Compare Nhats from Mark and Jags:

```{r compare_Nhats_BMA, include=F, echo=F}

#Abundance estimates between the two models were similar?
Nhats <- data.frame(N_mean_Jags = N.Phi.hats.Jags$Nhats$mean,
                    N_median_Jags = N.Phi.hats.Jags$Nhats$median,
                    N_lcl_Jags = N.Phi.hats.Jags$Nhats$lcl,
                    N_ucl_Jags = N.Phi.hats.Jags$Nhats$ucl,
                    N_mean_Mark = c(N.Phi.p.hats.Mark$Nhats$Nhat, NA),
                    N_lcl_Mark = c(N.Phi.p.hats.Mark$Nhats$lcl, NA),
                    N_ucl_Mark = c(N.Phi.p.hats.Mark$Nhats$ucl, NA))

p.Nhats.comparison <- ggplot(data = Nhats) +
  geom_point(aes(x = N_mean_Jags, y = N_mean_Mark)) +
  geom_errorbar(aes(x = N_mean_Jags, ymin = N_lcl_Mark, ymax = N_ucl_Mark)) +
  geom_errorbarh(aes(y = N_mean_Mark, xmin = N_lcl_Jags, xmax = N_ucl_Jags)) +
  geom_abline(slope = 1, intercept = 0)

#p.Nhats.comparison
```

These estimates (Mark and Jags) are very close to each other and I feel good about them! :)


#### GNO

```{r capture_history_GNO, echo=FALSE}
loc <- "GNO"
dat.1.Cm.community <- filter(dat.1.Cm, community == loc)
CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", loc, ".rds"))
n.occ <- ncol(CJS.data$data)
n.caught <- colSums(CJS.data$data)

p.captures <- ggplot(dat.1.Cm.community) + 
  geom_point(aes(x = DATE,  y = ID)) +
  geom_path(aes(x = DATE, y = ID)) +
  theme(axis.text.y = element_blank()) +
  labs(title = loc)

if (save.fig)
  ggsave(filename = paste0("figures/Cm_capture_history_", loc, ".png"),
         plot = p.captures, device = "png", dpi = 600,
         height = fig.height, width = fig.width)

n.caps <- rowSums(CJS.data$data) %>% 
  data.frame() %>% 
  rownames_to_column(var = "ID") 

colnames(n.caps) <- c("ID", "n")   # there has to be a better way but... 

p.n.captures <- ggplot(data = n.caps) + 
  geom_histogram(aes(x = n), binwidth = 1) +
  labs(title = loc)

if (save.fig)
  ggsave(filename = paste0("figures/Cm_capture_histogram_", loc, ".png"),
         plot = p.n.captures, device = "png", dpi = 600,
         height = fig.height, width = fig.width)

```

At ```r loc```, there were ```r nrow(CJS.data$data)``` turtles in the dataset. However, the numbers of turtles caught per capture occasion before ```r Cm.inputs$first.sample.date``` were insufficient to include in CMR analyses and excluded. Consequently, the capture histories of ```r nrow(Cm.inputs$CH.1)``` individual turtles from ```r Cm.inputs$first.sample.date``` to ```r max(dat.1.Cm.community$DATE)``` were used in the analysis. There were ```r n.occ``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)```. The number of captures per individual ranged from ```r min(rowSums(CJS.data$data))``` to ```r max(rowSums(CJS.data$data))``` with the median of ```r median(rowSums(CJS.data$data))``` and the mean of ```r signif(mean(rowSums(CJS.data$data)), 2)``` (Figure x). 


```{r plot_Cap_His_GNO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Capture histories of tagged green turtles at BKS. Each filled circle indicates a capture event and the same individuals are connected by lines."}
knitr::include_graphics(paste0("figures/Cm_capture_history_", loc, ".png"))
```


```{r plot_Cap_n_GNO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. The number of times individual green turtles were captured at BKS. "}
knitr::include_graphics(paste0("figures/Cm_capture_histogram_", loc, ".png"))
```

##### Mark
```{r model_comp_GNO, echo=F}
Cm.results.Mark <- readRDS(file = paste0("RData/CJS_Cm_RMark_", loc, ".rds"))

GNO.models.df <- model.table(Cm.results.Mark)%>% select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model)) #%>%tilde12dot()
```

```{r table_models_GNO, echo=F, include=T}
knitr::kable(GNO.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = paste0("Table. Model comparison for community ", loc),
             table.attr = "style='width:30%;'")
```


Although Phi[TSM]p[t] was the best model, the mean estimate of the survival rate of residents and transients was virtually 1.0 (estimate = ```r N.Phi.p.hats.Mark$Phihats[1, "estimate"]```) and its confidence ranged from virtually 0 to 1.0 . The second best model wad only ```r signif(GNO.models.df[2, "DeltaAICc"], 2)` AICc units away from the best model. Consequently, we used the second best model (Phi[~1]p[t]) to make inference. 

```{r parameter_estimates_GNO, echo=F, warning=FALSE, message=FALSE}
real.estimates <- Cm.results.Mark$Phi.dot.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

p.Nhats <- ggplot(data = N.Phi.p.hats.Mark$Nhats) +
  geom_point(aes(x = season, y = (Nhat))) +
  geom_errorbar(aes(x = season, ymin = (lcl2), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, ".png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


```{r plot_Nhats_GNO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at GNO when the maximum likelihood approach and the Phi[~1]p[t] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, ".png"))
```

Using the Phi[.]p[t] model, the survival rate was estimated to be ```r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"], 3)``` (SE = ```r signif(N.Phi.p.hats.Mark$Phihats[1, "se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats.Mark$Phihats[1, "lcl"], 2)``` - ```r signif(N.Phi.p.hats.Mark$Phihats[1, "ucl"], 2)```]). 

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T),2)``` to ```r format(signif(max(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T), 5), big.mark = ",")``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x).

##### Bayesian

###### Using the same data and model as Mark

```{r parameter_estimates_jags_v5_GNO, echo=F, include=F}
# v5 means the same data and model as what Mark selected
#loc <- "GNO"
N.Phi.hats.Jags <- stats.Bayesian_v5(models.MARK.old, loc)

p.Nhats <- ggplot(data = N.Phi.hats.Jags$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the Phi[~1]p[t] model, the estimated mean survival rate was ```r signif(N.Phi.hats.Jags$Phihats$mean, 3)``` (SD = ```r signif(N.Phi.hats.Jags$Phihats$sd, 3)```, 95% CI = [```r signif(N.Phi.hats.Jags$Phihats$lcl, 3)``` - ```r signif(N.Phi.hats.Jags$Phihats$ucl, 3)```]), which was less than the estimates from the ML approach.

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 3)``` with large uncertainty. 

```{r plot_Nhats_jags_v5_GNO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at BKS when the Bayesian approach, the Phi[~1]p[t] model, and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```

Compare Nhats from Mark and Jags:

```{r compare_Nhats_GNO, include=F, echo=F}

#Abundance estimates between the two models were similar?
Nhats <- data.frame(N_mean_Jags = N.Phi.hats.Jags$Nhats$mean,
                    N_median_Jags = N.Phi.hats.Jags$Nhats$median,
                    N_lcl_Jags = N.Phi.hats.Jags$Nhats$lcl,
                    N_ucl_Jags = N.Phi.hats.Jags$Nhats$ucl,
                    N_mean_Mark = c(N.Phi.p.hats.Mark$Nhats$Nhat, NA),
                    N_lcl_Mark = c(N.Phi.p.hats.Mark$Nhats$lcl, NA),
                    N_ucl_Mark = c(N.Phi.p.hats.Mark$Nhats$ucl, NA))

p.Nhats.comparison <- ggplot(data = Nhats) +
  geom_point(aes(x = N_mean_Jags, y = N_mean_Mark)) +
  geom_errorbar(aes(x = N_mean_Jags, ymin = N_lcl_Mark, ymax = N_ucl_Mark)) +
  geom_errorbarh(aes(y = N_mean_Mark, xmin = N_lcl_Jags, xmax = N_ucl_Jags)) +
  geom_abline(slope = 1, intercept = 0)

#p.Nhats.comparison
```

Not very good. Mark's estimates are a lot higher than those from Jags. There were some NAs in Nhat estiamtes for Mark as well... probably not a good one to provide estimates. 

###### Using the entire data and Phi[TSM] model

```{r parameter_estimates_jags_GNO, echo=F, warning=FALSE, message=FALSE}
# for this location, the transient model was the best so instead of phi's we have gamma's
#loc <- "GNO"
N.Phi.hats.Jags.TSM <- stats.Bayesian(models.MARK, loc)

p.Nhats <- ggplot(data = N.Phi.hats.Jags.TSM$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


```{r plot_Nhats_jags_GNO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at GNO when the Bayesian approach with the Phi[TSM]p[~1] model was used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags.png"))
```

Using the ```r models.MARK %>% filter(community == loc) %>% select(model)``` model, the survival rate of residents was estimated to be ```r signif(N.Phi.hats.Jags.TSM$Gammahats[1,"mean"], 3)``` (mean, SD = ```r signif(N.Phi.hats.Jags.TSM$Gammahats[1,"sd"], 3)```, 95% CI = [```r signif(N.Phi.hats.Jags.TSM$Gammahats[1, "lcl"], 3)``` - ```r signif(N.Phi.hats.Jags.TSM$Gammahats[1, "ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.hats.Jags.TSM$Gammahats[1, "mean"]/N.Phi.hats.Jags.TSM$Gammahats[2, "mean"], 3)``` using the two survival rate estimates (one for transients and residents and another for residents only).

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats.Jags.TSM$Nhats$mean, na.rm = T), 2)``` to ```r format(signif(max(N.Phi.hats.Jags.TSM$Nhats$mean, na.rm = T), 5), big.mark = ",")``` with large uncertainty. However, extreme estimates and their uncertainties were less than those from MARK or the Bayesian approach with the Phi[~1]p[t] model. 

#### IES

```{r capture_history_IES, echo=FALSE}
loc <- "IES"
dat.1.Cm.community <- filter(dat.1.Cm, community == loc)
CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", loc, ".rds"))

n.occ <- ncol(CJS.data$data)
n.caught <- colSums(CJS.data$data)

p.captures <- ggplot(dat.1.Cm.community) + 
  geom_point(aes(x = DATE,  y = ID)) +
  geom_path(aes(x = DATE, y = ID)) +
  theme(axis.text.y = element_blank()) +
  labs(title = loc)

if (save.fig)
  ggsave(filename = paste0("figures/Cm_capture_history_", loc, ".png"),
         plot = p.captures, device = "png", dpi = 600,
         height = fig.height, width = fig.width)

n.caps <- rowSums(CJS.data$data) %>% 
  data.frame() %>% 
  rownames_to_column(var = "ID") 

colnames(n.caps) <- c("ID", "n")   # there has to be a better way but... 

p.n.captures <- ggplot(data = n.caps) + 
  geom_histogram(aes(x = n), binwidth = 1) +
  labs(title = loc)

if (save.fig)
  ggsave(filename = paste0("figures/Cm_capture_histogram_", loc, ".png"),
         plot = p.n.captures, device = "png", dpi = 600,
         height = fig.height, width = fig.width)

```

At ```r loc```, there were ```r nrow(CJS.data$data)``` turtles in the dataset. However, the numbers of turtles caught per capture occasion before ```r Cm.inputs$first.sample.date``` were insufficient to include in CMR analyses and excluded. Consequently, the capture histories of ```r nrow(Cm.inputs$CH.1)``` individual turtles from ```r Cm.inputs$first.sample.date``` to ```r max(dat.1.Cm.community$DATE)``` were used in the analysis. There were ```r n.occ``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)```. The number of captures per individual ranged from ```r min(rowSums(CJS.data$data))``` to ```r max(rowSums(CJS.data$data))``` with the median of ```r median(rowSums(CJS.data$data))``` and the mean of ```r signif(mean(rowSums(CJS.data$data)), 2)``` (Figure x). 


```{r plot_Cap_His_IES, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Capture histories of tagged green turtles at IES. Each filled circle indicates a capture event and the same individuals are connected by lines."}
knitr::include_graphics(paste0("figures/Cm_capture_history_", loc, ".png"))
```


```{r plot_Cap_n_IES, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. The number of times individual green turtles were captured at IES."}
knitr::include_graphics(paste0("figures/Cm_capture_histogram_", loc, ".png"))
```


##### Mark

```{r model_comp_IES, echo=F}
Cm.results.Mark <- readRDS(file = paste0("RData/CJS_Cm_RMark_", loc, ".rds"))

IES.models.df <- model.table(Cm.results.Mark) %>% 
  select( model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model)) #%>%tilde12dot()
```

```{r table_models_IES, echo=F, include=T}
knitr::kable(IES.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = paste0("Table. Model comparison for community ", loc),
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_IES, echo=F, warning=FALSE, message=FALSE}
real.estimates <- Cm.results.Mark$Phi.tsm.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

# turn Nhats to NA when SE = 0 or SE > 1000
#Nhats.df[Nhats.df$SE_Nhat < 0.001 | Nhats.df$SE_Nhat > 1000, c("Nhat", "lcl", "ucl", "lcl2")] <- NA

p.Nhats <- ggplot(data = N.Phi.p.hats.Mark$Nhats) +
  geom_point(aes(x = season, y = (Nhat))) +
  geom_errorbar(aes(x = season, ymin = (lcl2), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, ".png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


Using the best model (Phi[TSM]p[t]), the estimated mean survival rate of residents was ```r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"], 3)``` (SE = ```r signif(N.Phi.p.hats.Mark$Phihats[1, "se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats.Mark$Phihats[1, "lcl"], 2)``` - ```r signif(N.Phi.p.hats.Mark$Phihats[1, "ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"]/N.Phi.p.hats.Mark$Phihats[2,"estimate"], 3)```, using the two survival rates (one for transients and residents and another for residents only). 

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T),2)``` to ```r signif(max(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T), 2)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x).


```{r plot_Nhats_IES, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients when the maximum likelihood approach and the Phi[TSM]p[t] model were used to analyze capture histories. Black filled circles indicate the means and error bars are 95% confidence intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, ".png"))
```

##### Bayesian

###### Using the same data and model as Mark

```{r parameter_estimates_jags_v5_IES, echo=F, include=F}
# v5 means the same data and model as what Mark selected
#loc <- "IES"
N.Phi.hats.Jags <- stats.Bayesian_v5(models.MARK.old, loc)

p.Nhats <- ggplot(data = N.Phi.hats.Jags$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (```r models.MARK.old %>% filter(community == loc) %>% select(model)```), the estimated mean survival rate of residents was ```r signif(N.Phi.hats.Jags$Gammahats[1, "mean"], 3)``` (SD = ```r signif(N.Phi.hats.Jags$Gammahats[1, "sd"], 3)```, 95% CI = [```r signif(N.Phi.hats.Jags$Gammahats[1, "lcl"], 3)``` - ```r signif(N.Phi.hats.Jags$Gammahats[1, "ucl"], 2)```]), these estimates are greater than those from the ML approach.

The proportion of residents was estimated to be ```r signif(N.Phi.hats.Jags$Gammahats[1,"mean"]/N.Phi.hats.Jags$Gammahats[2,"mean"], 3)```, which were less than that from the ML approach.  

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 3)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

```{r plot_Nhats_jags_v5_IES, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at IES when the Bayesian approach, the Phi[TSM]p[t] model and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```


```{r compare_Nhats_IES, include=F, echo=F}

#Abundance estimates between the two models were similar?
Nhats <- data.frame(N_mean_Jags = N.Phi.hats.Jags$Nhats$mean,
                    N_median_Jags = N.Phi.hats.Jags$Nhats$median,
                    N_lcl_Jags = N.Phi.hats.Jags$Nhats$lcl,
                    N_ucl_Jags = N.Phi.hats.Jags$Nhats$ucl,
                    N_mean_Mark = c(N.Phi.p.hats.Mark$Nhats$Nhat, NA),
                    N_lcl_Mark = c(N.Phi.p.hats.Mark$Nhats$lcl, NA),
                    N_ucl_Mark = c(N.Phi.p.hats.Mark$Nhats$ucl, NA))

p.Nhats.comparison <- ggplot(data = Nhats) +
  geom_point(aes(x = N_mean_Jags, y = N_mean_Mark)) +
  geom_errorbar(aes(x = N_mean_Jags, ymin = N_lcl_Mark, ymax = N_ucl_Mark)) +
  geom_errorbarh(aes(y = N_mean_Mark, xmin = N_lcl_Jags, xmax = N_ucl_Jags)) +
  geom_abline(slope = 1, intercept = 0)

#p.Nhats.comparison
```

Not very good either... 

#### LSI

```{r capture_history_LSI, echo=FALSE}
loc <- "LSI"
dat.1.Cm.community <- filter(dat.1.Cm, community == loc)
CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", loc, ".rds"))

n.occ <- ncol(CJS.data$data)
n.caught <- colSums(CJS.data$data)

p.captures <- ggplot(dat.1.Cm.community) + 
  geom_point(aes(x = DATE,  y = ID)) +
  geom_path(aes(x = DATE, y = ID)) +
  theme(axis.text.y = element_blank()) +
  labs(title = loc)

if (save.fig)
  ggsave(filename = paste0("figures/Cm_capture_history_", loc, ".png"),
         plot = p.captures, device = "png", dpi = 600,
         height = fig.height, width = fig.width)

n.caps <- rowSums(CJS.data$data) %>% 
  data.frame() %>% 
  rownames_to_column(var = "ID") 

colnames(n.caps) <- c("ID", "n")   # there has to be a better way but... 

p.n.captures <- ggplot(data = n.caps) + 
  geom_histogram(aes(x = n), binwidth = 1) +
  labs(title = loc)

if (save.fig)
  ggsave(filename = paste0("figures/Cm_capture_histogram_", loc, ".png"),
         plot = p.n.captures, device = "png", dpi = 600,
         height = fig.height, width = fig.width)
```

At ```r loc```, there were ```r nrow(CJS.data$data)``` turtles in the dataset. However, the numbers of turtles caught per capture occasion before ```r Cm.inputs$first.sample.date``` were insufficient to include in CMR analyses and excluded. Consequently, the capture histories of ```r nrow(Cm.inputs$CH.1)``` individual turtles from ```r Cm.inputs$first.sample.date``` to ```r max(dat.1.Cm.community$DATE)``` were used in the analysis. There were ```r n.occ``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)```. The number of captures per individual ranged from ```r min(rowSums(CJS.data$data))``` to ```r max(rowSums(CJS.data$data))``` with the median of ```r median(rowSums(CJS.data$data))``` and the mean of ```r signif(mean(rowSums(CJS.data$data)), 2)``` (Figure x). 


```{r plot_Cap_His_LSI, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Capture histories of tagged green turtles at LSI. Each filled circle indicates a capture event and the same individuals are connected by lines."}
knitr::include_graphics(paste0("figures/Cm_capture_history_", loc, ".png"))
```


```{r plot_Cap_n_LSI, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. The number of times individual green turtles were captured at LSI."}
knitr::include_graphics(paste0("figures/Cm_capture_histogram_", loc, ".png"))
```

##### Mark

```{r model_comp_LSI, echo=F}
Cm.results.Mark <- readRDS(file = paste0("RData/CJS_Cm_RMark_", loc, ".rds"))

LSI.models.df <- model.table(Cm.results.Mark)%>% select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model)) #%>%tilde12dot()
```

The best model was Phi[.]p[t]. The second best model (Phi[TSM]p[t]) was only `r signif(LSI.models.df[2, "DeltaAICc"], 2)` away from the best model. 

```{r table_models_LSI, echo=F, include=T}
knitr::kable(LSI.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = paste0("Table. Model comparison for community ", loc),
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_LSI, echo=F, message=FALSE, warning=FALSE}
real.estimates <- Cm.results.Mark$Phi.dot.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

# turn Nhats to NA when SE = 0 or SE > 1000
#Nhats.df[Nhats.df$SE_Nhat < 0.001 | Nhats.df$SE_Nhat > 1000, c("Nhat", "lcl", "ucl", "lcl2")] <- NA

p.Nhats <- ggplot(data = N.Phi.p.hats.Mark$Nhats) +
  geom_point(aes(x = season, y = (Nhat))) +
  geom_errorbar(aes(x = season, ymin = (lcl2), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, ".png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


Using the best model (Phi[~1]p[t]), the survival rate was estimated to be ```r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"], 3)``` (SE = ```r signif(N.Phi.p.hats.Mark$Phihats[1, "se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats.Mark$Phihats[1, "lcl"], 2)``` - ```r signif(N.Phi.p.hats.Mark$Phihats[1, "ucl"], 2)```]). 

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T),2)``` to ```r signif(max(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T), 2)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x).

Using the second model (Phi[TSM]p[t]), the estimated mean survival rate of residents was ```r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"]), 3)``` (SD = ```r signif(N.Phi.p.hats.Mark$Phihats[1,"se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats.Mark$Phihats[1,"lcl"], 3)``` - ```r signif(N.Phi.p.hats.Mark$Phihats[1,"ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"]/N.Phi.p.hats.Mark$Phihats[2,"estimate"], 3)```, using the two survival rates (one for transients and residents and another for residents only). 


```{r plot_Nhats_LSI, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at LSI when the maximum likelihood approach and the Phi[~1]p[t] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_LSI.png"))
```

##### Bayesian

###### Using the same data and model as Mark

```{r parameter_estimates_jags_v5_LSI, echo=F, include=F}
# v5 means the same data and model as what Mark selected
#loc <- "LSI"
N.Phi.hats.Jags <- stats.Bayesian_v5(models.MARK.old, loc)

p.Nhats <- ggplot(data = N.Phi.hats.Jags$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (```r models.MARK.old %>% filter(community == loc) %>% select(model)```), the estimated mean survival rate was ```r signif(N.Phi.hats.Jags$Phihats$mean, 3)``` (SD = ```r signif(N.Phi.hats.Jags$Phihats$sd, 3)```, 95% CI = [```r signif(N.Phi.hats.Jags$Phihats$lcl, 3)``` - ```r signif(N.Phi.hats.Jags$Phihats$ucl, 3)```]), which was less than the estimates from the ML approach.

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 3)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

```{r plot_Nhats_jags_v5_LSI, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at LSI when the Bayesian approach, the Phi[~1]p[t] model and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```


```{r compare_Nhats_LSI, include=F, echo=F}

#Abundance estimates between the two models were similar?
Nhats <- data.frame(N_mean_Jags = N.Phi.hats.Jags$Nhats$mean,
                    N_median_Jags = N.Phi.hats.Jags$Nhats$median,
                    N_lcl_Jags = N.Phi.hats.Jags$Nhats$lcl,
                    N_ucl_Jags = N.Phi.hats.Jags$Nhats$ucl,
                    N_mean_Mark = c(N.Phi.p.hats.Mark$Nhats$Nhat, NA),
                    N_lcl_Mark = c(N.Phi.p.hats.Mark$Nhats$lcl, NA),
                    N_ucl_Mark = c(N.Phi.p.hats.Mark$Nhats$ucl, NA))

p.Nhats.comparison <- ggplot(data = Nhats) +
  geom_point(aes(x = N_mean_Jags, y = N_mean_Mark)) +
  geom_errorbar(aes(x = N_mean_Jags, ymin = N_lcl_Mark, ymax = N_ucl_Mark)) +
  geom_errorbarh(aes(y = N_mean_Mark, xmin = N_lcl_Jags, xmax = N_ucl_Jags)) +
  geom_abline(slope = 1, intercept = 0)

#p.Nhats.comparison
```

The comparison between estimates from Mark and Jags indicated they were quite different (Mark's estimates were greater than those from Jags). I would not use these estimates. 

###### Using the entire data and Phi[TSM] model

```{r parameter_estimates_jags_LSI, echo=F, message=FALSE, warning=FALSE}
# for this location, the transient model was the best so instead of phi's we have gamma's
#loc <- "LSI"
N.Phi.hats.Jags.TSM <- stats.Bayesian(models.MARK, loc)

p.Nhats <- ggplot(data = N.Phi.hats.Jags.TSM$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_TSM.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


Using the Phi[TSM]p[t] model, the mean survival rate of residents was ```r signif(N.Phi.hats.Jags.TSM$Gammahats[1,"mean"], 3)``` (mean, SD = ```r signif(N.Phi.hats.Jags.TSM$Gammahats[1,"sd"], 3)```, 95% CI = [```r signif(N.Phi.hats.Jags.TSM$Gammahats[1, "lcl"], 3)``` - ```r signif(N.Phi.hats.Jags.TSM$Gammahats[1, "ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.hats.Jags.TSM$Gammahats[1, "mean"]/N.Phi.hats.Jags.TSM$Gammahats[2, "mean"], 3)``` using the two survival rate estimates (one for transients and residents and another for residents only).

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats.Jags.TSM$Nhats$mean, na.rm = T), 2)``` to ```r format(signif(max(N.Phi.hats.Jags.TSM$Nhats$mean, na.rm = T), 5), big.mark = ",")```. These estimates were more precise than the ML estimates.  


```{r plot_Nhats_jags_TSM_LSI, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at LSI including transients when the Bayesian approach, the entire dataset, and the Phi[TSM]p[t] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_TSM.png"))
```

#### MUL

```{r capture_history_MUL, echo=FALSE}
loc <- "MUL"
dat.1.Cm.community <- filter(dat.1.Cm, community == loc)
CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", loc, ".rds"))
n.occ <- ncol(CJS.data$data)
n.caught <- colSums(CJS.data$data)

p.captures <- ggplot(dat.1.Cm.community) + 
  geom_point(aes(x = DATE,  y = ID)) +
  geom_path(aes(x = DATE, y = ID)) +
  theme(axis.text.y = element_blank()) +
  labs(title = loc)

if (save.fig)
  ggsave(filename = paste0("figures/Cm_capture_history_", loc, ".png"),
         plot = p.captures, device = "png", dpi = 600,
         height = fig.height, width = fig.width)

n.caps <- rowSums(CJS.data$data) %>% 
  data.frame() %>% 
  rownames_to_column(var = "ID") 

colnames(n.caps) <- c("ID", "n")   # there has to be a better way but... 

p.n.captures <- ggplot(data = n.caps) + 
  geom_histogram(aes(x = n), binwidth = 1) +
  labs(title = loc)

if (save.fig)
  ggsave(filename = paste0("figures/Cm_capture_histogram_", loc, ".png"),
         plot = p.n.captures, device = "png", dpi = 600,
         height = fig.height, width = fig.width)

```

At ```r loc```, there were ```r nrow(CJS.data$data)``` turtles in the dataset. However, the numbers of turtles caught per capture occasion before ```r Cm.inputs$first.sample.date``` were insufficient to include in CMR analyses and excluded. Consequently, the capture histories of ```r nrow(Cm.inputs$CH.1)``` individual turtles from ```r Cm.inputs$first.sample.date``` to ```r max(dat.1.Cm.community$DATE)``` were used in the analysis. There were ```r n.occ``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)```. The number of captures per individual ranged from ```r min(rowSums(CJS.data$data))``` to ```r max(rowSums(CJS.data$data))``` with the median of ```r median(rowSums(CJS.data$data))``` and the mean of ```r signif(mean(rowSums(CJS.data$data)), 2)``` (Figure x). 

There aren't many recaptures for this site. 

```{r plot_Cap_His_MUL, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Capture histories of tagged green turtles at MUL. Each filled circle indicates a capture event and the same individuals are connected by lines."}
knitr::include_graphics(paste0("figures/Cm_capture_history_", loc, ".png"))
```


```{r plot_Cap_n_MUL, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. The number of times individual green turtles were captured at MUL."}
knitr::include_graphics(paste0("figures/Cm_capture_histogram_", loc, ".png"))
```

##### Mark

```{r model_comp_MUL, echo=F}
Cm.results.Mark <- readRDS(file = paste0("RData/CJS_Cm_RMark_", loc, ".rds"))

MUL.models.df <- model.table(Cm.results.Mark)%>% select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model)) #%>%tilde12dot()
```

Because of the few recaptures, I don't think it's meaningful to fit CMR models to these data... The model selection process shows that a lot of models were fit equally. 


```{r table_models_MUL, echo=F, include=T}
knitr::kable(MUL.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = paste0("Table. Model comparison for community ", loc),
             table.attr = "style='width:30%;'")
```

```{r parameter_estimates_MUL, echo=F, message=FALSE, warning=FALSE}
real.estimates <- Cm.results.Mark$Phi.dot.p.dot$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

p.Nhats <- ggplot(data = N.Phi.p.hats.Mark$Nhats) +
  geom_point(aes(x = season, y = (Nhat))) +
  geom_errorbar(aes(x = season, ymin = (lcl2), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, ".png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


Using the best model, the survival rate was estimated to be ```r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"], 3)``` (SE = ```r signif(N.Phi.p.hats.Mark$Phihats[1, "se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats.Mark$Phihats[1, "lcl"], 2)``` - ```r signif(N.Phi.p.hats.Mark$Phihats[1, "ucl"], 2)```]). 

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T),2)``` to ```r signif(max(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T), 2)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x).

```{r plot_Nhats_MUL, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at MUL when the maximum likelihood approach and the Phi[~1]p[~1] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, ".png"))
```

I think these estimates are not very useful... given the few recaptures. 

##### Bayesian

###### Using the same data and model as Mark

```{r parameter_estimates_jags_v5_MUL, echo=F, include=F}
# v5 means the same data and model as what Mark selected
#loc <- "MUL"
N.Phi.hats.Jags <- stats.Bayesian_v5(models.MARK.old, loc)

p.Nhats <- ggplot(data = N.Phi.hats.Jags$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (```r models.MARK.old %>% filter(community == loc) %>% select(model)```), the estimated survival rate was ```r signif(N.Phi.hats.Jags$Phihats$mean, 3)``` (mean, SD = ```r signif(N.Phi.hats.Jags$Phihats$sd, 3)```, 95% CI = [```r signif(N.Phi.hats.Jags$Phihats$lcl, 3)``` - ```r signif(N.Phi.hats.Jags$Phihats$ucl, 3)```]).

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 3)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

```{r plot_Nhats_jags_v5_MUL, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at MUL when the Bayesian approach, the Phi[~1]p[~1] model, and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```


#### PAO

```{r capture_history_PAO, echo=FALSE}
loc <- "PAO"
dat.1.Cm.community <- filter(dat.1.Cm, community == loc)
CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", loc, ".rds"))
n.occ <- ncol(CJS.data$data)
n.caught <- colSums(CJS.data$data)

p.captures <- ggplot(dat.1.Cm.community) + 
  geom_point(aes(x = DATE,  y = ID)) +
  geom_path(aes(x = DATE, y = ID)) +
  theme(axis.text.y = element_blank()) +
  labs(title = loc)

if (save.fig)
  ggsave(filename = paste0("figures/Cm_capture_history_", loc, ".png"),
         plot = p.captures, device = "png", dpi = 600,
         height = fig.height, width = fig.width)

n.caps <- rowSums(CJS.data$data) %>% 
  data.frame() %>% 
  rownames_to_column(var = "ID") 

colnames(n.caps) <- c("ID", "n")   # there has to be a better way but... 

p.n.captures <- ggplot(data = n.caps) + 
  geom_histogram(aes(x = n), binwidth = 1) +
  labs(title = loc)

if (save.fig)
  ggsave(filename = paste0("figures/Cm_capture_histogram_", loc, ".png"),
         plot = p.n.captures, device = "png", dpi = 600,
         height = fig.height, width = fig.width)

```

At ```r loc```, there were ```r nrow(CJS.data$data)``` turtles in the dataset. However, the numbers of turtles caught per capture occasion before ```r Cm.inputs$first.sample.date``` were insufficient to include in CMR analyses and excluded. Consequently, the capture histories of ```r nrow(Cm.inputs$CH.1)``` individual turtles from ```r Cm.inputs$first.sample.date``` to ```r max(dat.1.Cm.community$DATE)``` were used in the analysis. There were ```r n.occ``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)```. The number of captures per individual ranged from ```r min(rowSums(CJS.data$data))``` to ```r max(rowSums(CJS.data$data))``` with the median of ```r median(rowSums(CJS.data$data))``` and the mean of ```r signif(mean(rowSums(CJS.data$data)), 2)``` (Figure x). 


```{r plot_Cap_His_PAO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Capture histories of tagged green turtles at PAO. Each filled circle indicates a capture event and the same individuals are connected by lines."}
knitr::include_graphics(paste0("figures/Cm_capture_history_", loc, ".png"))
```


```{r plot_Cap_n_PAO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. The number of times individual green turtles were captured at PAO."}
knitr::include_graphics(paste0("figures/Cm_capture_histogram_", loc, ".png"))
```

##### Mark
```{r model_comp_PAO, echo=F}
Cm.results.Mark <- readRDS(file = paste0("RData/CJS_Cm_RMark_", loc, ".rds"))

PAO.models.df <- model.table(Cm.results.Mark) %>% 
  select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model)) #%>%tilde12dot()
```


```{r table_models_PAO, echo=F, include=T}
knitr::kable(PAO.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = paste0("Table. Model comparison for community ", loc),
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_PAO, echo=F, message=FALSE, warning=FALSE}

real.estimates <- Cm.results.Mark$Phi.dot.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

# turn Nhats to NA when SE = 0 or SE > 1000
#Nhats.df[Nhats.df$SE_Nhat < 0.001 | Nhats.df$SE_Nhat > 5000, c("Nhat", "lcl", "ucl", "lcl2")] <- NA

p.Nhats <- ggplot(data = N.Phi.p.hats.Mark$Nhats) +
  geom_point(aes(x = season, y = (Nhat))) +
  geom_errorbar(aes(x = season, ymin = (lcl2), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, ".png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


Using the best model, the survival rate was estimated to be ```r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"], 3)``` (SE = ```r signif(N.Phi.p.hats.Mark$Phihats[1, "se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats.Mark$Phihats[1, "lcl"], 2)``` - ```r signif(N.Phi.p.hats.Mark$Phihats[1, "ucl"], 2)```]). 

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T),2)``` to ```r format(signif(max(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T), 5), big.mark = ",")``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x).


```{r plot_Nhats_PAO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at PAO when the maximum likelihood approach and the Phi[~1]p[t] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, ".png"))
```

##### Bayesian

###### Using the same data and model as Mark

```{r parameter_estimates_jags_v5_PAO, echo=F, include=F}
# v5 means the same data and model as what Mark selected
#loc <- "PAO"
N.Phi.hats.Jags <- stats.Bayesian_v5(models.MARK.old, loc)

p.Nhats <- ggplot(data = N.Phi.hats.Jags$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (```r models.MARK.old %>% filter(community == loc) %>% select(model)```), the estimated mean survival rate was ```r signif(N.Phi.hats.Jags$Phihats$mean, 3)``` (mean, SD = ```r signif(N.Phi.hats.Jags$Phihats$sd, 3)```, 95% CI = [```r signif(N.Phi.hats.Jags$Phihats$lcl, 3)``` - ```r signif(N.Phi.hats.Jags$Phihats$ucl, 3)```]).

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 2)``` to ```r format(signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 3), big.mark = ",")``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

```{r plot_Nhats_jags_v5_PAO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at PAO when the Bayesian approach, the Phi[~1]p[t] model and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```

###### Using the entire data and Phi[TSM] model

```{r parameter_estimates_jags_PAO, echo=F, message=FALSE, warning=FALSE}
#loc <- "PAO"
N.Phi.hats.TSM.Jags <- stats.Bayesian(models.MARK, loc)

p.Nhats <- ggplot(data = N.Phi.hats.TSM.Jags$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_TSM_jags.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


Using the ```r models.MARK %>% filter(community == loc) %>% select(model)``` model, the survival rate of residents was estimated to be ```r signif(N.Phi.hats.TSM.Jags$Gammahats[1,"mean"], 3)``` (mean, SD = ```r signif(N.Phi.hats.TSM.Jags$Gammahats[1,"sd"], 3)```, 95% CI = [```r signif(N.Phi.hats.TSM.Jags$Gammahats[1, "lcl"], 3)``` - ```r signif(N.Phi.hats.TSM.Jags$Gammahats[1, "ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.hats.TSM.Jags$Gammahats[1, "mean"]/N.Phi.hats.TSM.Jags$Gammahats[2, "mean"], 3)``` using the two survival rate estimates (one for transients and residents and another for residents only).

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats.TSM.Jags$Nhats$mean, na.rm = T), 2)``` to ```r format(signif(max(N.Phi.hats.TSM.Jags$Nhats$mean, na.rm = T), 5), big.mark = ",")```. 


```{r plot_Nhats_jags_PAO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at PAO when the Bayesian approach, the Phi[TSM]p[t] model and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_TSM_jags.png"))
```

#### PLM

```{r capture_history_PLM, echo=FALSE}
loc <- "PLM"
dat.1.Cm.community <- filter(dat.1.Cm, community == loc)
CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", loc, ".rds"))
n.occ <- ncol(CJS.data$data)
n.caught <- colSums(CJS.data$data)

p.captures <- ggplot(dat.1.Cm.community) + 
  geom_point(aes(x = DATE,  y = ID)) +
  geom_path(aes(x = DATE, y = ID)) +
  theme(axis.text.y = element_blank()) +
  labs(title = loc)

if (save.fig)
  ggsave(filename = paste0("figures/Cm_capture_history_", loc, ".png"),
         plot = p.captures, device = "png", dpi = 600,
         height = fig.height, width = fig.width)

n.caps <- rowSums(CJS.data$data) %>% 
  data.frame() %>% 
  rownames_to_column(var = "ID") 

colnames(n.caps) <- c("ID", "n")   # there has to be a better way but... 

p.n.captures <- ggplot(data = n.caps) + 
  geom_histogram(aes(x = n), binwidth = 1) +
  labs(title = loc)

if (save.fig)
  ggsave(filename = paste0("figures/Cm_capture_histogram_", loc, ".png"),
         plot = p.n.captures, device = "png", dpi = 600,
         height = fig.height, width = fig.width)

```

At ```r loc```, there were ```r nrow(CJS.data$data)``` turtles in the dataset. However, the numbers of turtles caught per capture occasion before ```r Cm.inputs$first.sample.date``` were insufficient to include in CMR analyses and excluded. Consequently, the capture histories of ```r nrow(Cm.inputs$CH.1)``` individual turtles from ```r Cm.inputs$first.sample.date``` to ```r max(dat.1.Cm.community$DATE)``` were used in the analysis. There were ```r n.occ``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)```. The number of captures per individual ranged from ```r min(rowSums(CJS.data$data))``` to ```r max(rowSums(CJS.data$data))``` with the median of ```r median(rowSums(CJS.data$data))``` and the mean of ```r signif(mean(rowSums(CJS.data$data)), 2)``` (Figure x). 


```{r plot_Cap_His_PLM, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Capture histories of tagged green turtles at PLM. Each filled circle indicates a capture event and the same individuals are connected by lines."}
knitr::include_graphics(paste0("figures/Cm_capture_history_", loc, ".png"))
```


```{r plot_Cap_n_PLM, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. The number of times individual green turtles were captured at PLM."}
knitr::include_graphics(paste0("figures/Cm_capture_histogram_", loc, ".png"))
```

##### Mark

```{r model_comp_PLM, echo=F}
Cm.results.Mark <- readRDS(file = paste0("RData/CJS_Cm_RMark_", loc, ".rds"))

PLM.models.df <- model.table(Cm.results.Mark)%>% select( model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model)) #%>%tilde12dot()
```

```{r table_models_PLM, echo=F, include=T}
knitr::kable(PLM.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = paste0("Table. Model comparison for community ", loc),
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_PLM, echo=F, message=FALSE, warning=FALSE}

real.estimates <- Cm.results.Mark$Phi.tsm.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats.Mark <- extract.Nhats(Cm.inputs, Cm.results.Mark, real.estimates)

# turn Nhats to NA when SE = 0 or SE > 1000
#Nhats.df[Nhats.df$SE_Nhat < 0.001 | Nhats.df$SE_Nhat > 1000, c("Nhat", "lcl", "ucl", "lcl2")] <- NA

p.Nhats <- ggplot(data = N.Phi.p.hats.Mark$Nhats) +
  geom_point(aes(x = season, y = (Nhat))) +
  geom_errorbar(aes(x = season, ymin = (lcl2), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, ".png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


Using the best model, the survival rate was estimated to be ```r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"], 3)``` (SE = ```r signif(N.Phi.p.hats.Mark$Phihats[1, "se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats.Mark$Phihats[1, "lcl"], 2)``` - ```r signif(N.Phi.p.hats.Mark$Phihats[1, "ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.p.hats.Mark$Phihats[1,"estimate"]/N.Phi.p.hats.Mark$Phihats[2,"estimate"], 3)```, using the two survival rates (one for transients and residents and another for residents only). 

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T),2)``` to ```r format(max(N.Phi.p.hats.Mark$Nhats$Nhat, na.rm = T), big.mark = ",")``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x).


```{r plot_Nhats_PLM, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at PLM when the maximum likelihood approach and the Phi[TSM]p[t] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, ".png"))
```

##### Bayesian

###### Using the same data and model as Mark

```{r parameter_estimates_jags_v5_PLM, echo=F, include=F}
# v5 means the same data and model as what Mark selected
#loc <- "PLM"
N.Phi.hats.Jats <- stats.Bayesian_v5(models.MARK.old, loc)

p.Nhats <- ggplot(data = N.Phi.hats.Jags$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (```r models.MARK.old %>% filter(community == loc) %>% select(model)```), the estimated mean survival rate of residents was ```r signif(N.Phi.hats.Jags$Gammahats[1, "mean"], 3)``` (SD = ```r signif(N.Phi.hats.Jags$Gammahats[1, "sd"], 3)```, 95% CI = [```r signif(N.Phi.hats.Jags$Gammahats[1, "lcl"], 3)``` - ```r signif(N.Phi.hats.Jags$Gammahats[1, "ucl"], 2)```]).

The proportion of residents was estimated to be ```r signif(N.Phi.hats.Jags$Gammahats[1,"mean"]/N.Phi.p.hats.Jags$Gammahats[2,"mean"], 3)```, using the two survival rates (one for transients and residents and another for residents only). 

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats.Jags$Nhats$mean, na.rm = T), 3)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

```{r plot_Nhats_jags_v5_PLM, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at PLM when the Bayesian approach, the Phi[TSM]p[t], the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```

