---
title: "Capture mark recapture analysis of green turtles"
author: "Tomo Eguchi"
date: "4/1/2021"
output: word_document
---

```{r setup, include=FALSE, echo=FALSE}
rm(list=ls())

knitr::opts_chunk$set(echo = TRUE)

library(jagsUI)
library(tidyverse)
library(lubridate)
library(reshape)
library(bayesplot)
library(ggridges)
library(RMark)
library(R2ucare)
library(loo)

source("Mancini_functions.R")
save.fig <- F
fig.height <- 4
fig.width <- 6

# a function to replace parentheses with brackets
# With parentheses, table entries are read as TeX, resulting in subscripts
# With brackets, they are all read as characters - must be a better way to
# deal with this stuff but couldn't find one 2021-01-08
paren2bracket <- function(df.in){
  tmp <- gsub("(", "[", df.in, fixed = T)
  tmp <- gsub(")", "]", tmp, fixed = T)
  return(tmp)
}

```

## Introduction

To estimate survival rate and abundance of green turtles, Cormack-Jolly-Seber (CJS) models were fitted to the capture-recapture dataset for green turtles. Results indicated that apparent changes in abundance might have been caused by sampling inequalities among study sites. In order to remove the inequalities, CJS models were fitted to data from each study site independently. This was justified by the lack of movements by turtles among the study sites. 

Briefly, the CJS model uses the capture history of each individual without assuming that the population is closed. There are two main parameters in the basic model; survival rate (phi) and capture/recapture probability (p).  The abundance may be estimated through the Horviz-Thompson estimator, where the number of captured individuals per temporal sampling period is divided by the estimated capture probability for that time period. The estimated survival rate should be considered as an apparent survival rate as the permanent emigrant is considered as dead.  Effects of transients, however, can be determined.   

The basic model can be extended to accommodate various modifications, such as time-dependent survival rates, time-dependent capture probability, covariate-dependent survival rates and capture probabilities.

## Methods

Capture-recapture data of green turtles were separated into study areas and CJS models were fitted using Mark via RMark. Analyses were done in Cm_CJS_v3_Mark_community.Rmd. Some capture events in the beginning of each time series were deleted because of the small numbers of captures (not all). Beginning dates for each dataset are listed in the .Rmd file. 

```{r data, echo=FALSE, include=T}

dat.1.Cm <- get.data.Cm("data/GTC_Cm Data_updated_2020-04-28_TE_v2.csv")

# Group by community and create CJS data for each community
community.names <- levels(as.factor(dat.1.Cm$community))
```

Communities with small proportions (< 0.05) of recaptures, i.e., the number of individuals caught more than once in the total number of individuals, were excluded from the analysis because of insufficient numbers of recaptures. 

```{r RMark, echo=FALSE, include=T}
# Analyses were completed in Cm_CJS_v3_Mark_community.Rmd
# some communities don't have enough recaptures to do CMR modeling
c <- 0
k <- 18
p.recap <- vector(mode = "numeric")
community.names.used <- vector(mode = "character")
Cm.results <- Cm.CJS.input <- vector(mode = "list")

for (k in 1:length(community.names)){
    dat.1.Cm.community <- filter(dat.1.Cm, community == community.names[k])
    CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
    n.GT2.cap <- length(which(rowSums(CJS.data$data) > 1))
    p.recap[k] <- n.GT2.cap/nrow(CJS.data$data)

    if (p.recap[k] > 0.05){
      community.names.used[c + 1] <- community.names[k]
    }
    
  if (file.exists(paste0("RData/CJS_Cm_RMark_", community.names[k], ".rds"))){
    Cm.results[[c+1]] <- readRDS(file = paste0("RData/CJS_Cm_RMark_", 
                                               community.names[k], ".rds"))
    Cm.CJS.input[[c+1]] <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_", 
                                                 community.names[k], ".rds"))
      c <- c + 1
  } 
  
}

mark.table <- model.table(Cm.results[[1]]) %>% rownames_to_column(var = "ID")
# 

```


Capture history data from each study area with sufficient numbers of recaptures were pooled by sampling seasons (summer and winter). In other words, multiple captures within each season were treated as one capture. 

I considered several possible CJS models for this analysis. For survival rates, they were treated as either constant or affected by transients (time-since-marking; TSM). For capture probabilities, they were treated as either constant, time dependent, different between the first and subsequent captures (trap response), different between summer and winter, or a function of effort. A total of 14 models were fitted to the data (Table 1).

I decided not to use individual covariates because there were many unobserved (295 NAs for SCL).


```{r model_defs, echo=F, include=T}

# tmp <- gsub("(", "[", mark.table$model, fixed = T)
# tmp <- gsub(")", "]", tmp, fixed = T)
mark.table$Model <- paren2bracket(mark.table$model)

knitr::kable(mark.table %>% select(ID, Model) %>% arrange(by = as.numeric(ID)), 
             digits = 2,
             caption = "Table 1. Definitions of 14 CJS models fitted to CMR data of green turtles. '~1' indicates a constant.",
             table.attr = "style='width:30%;'")
```

Abundance was estimated using the Horviz-Thompson estimator. 

Analyses were conducted using the maximum likelihood approach using Mark (White and Cooch Yr) through RMark (v. ```r packageVersion("RMark")```, Laake 2013). 

## Results
Of ```r length(community.names)``` communities, only ```r length(community.names.used)``` communities contained sufficient recaptures. Data for  ```r length(community.names) - length(community.names.used)```  communities were not used in the following analysis. Goodness of fit of CJS models was examined for each study area. Results from each community are provided separately in the following sections.

### Goodness of fit

```{r GOF, echo=F, include=F, cache=T, warning=F}

overall_Cm <- test3sr_Cm <- test3sm_Cm <- test2ct_Cm <- test2cl_Cm <- vector(mode = "list")

for (k in 1:length(community.names.used)){
  output.filename <- paste0("RData/CJS_Cm_RMark_input_", community.names.used[k], ".rds")
  
  results.k <- readRDS(file = output.filename)
  #CH.Ucare <-R2ucare::group_data(CJS.data$data, effX = rep(1, nrow(CJS.data$data)))
  CH.Ucare <- results.k$CH.R2ucare
  
  overall_Cm[[k]] <- list(community = community.names.used[k],
                          test.out = overall_CJS(as.matrix(CH.Ucare[, 1:(ncol(CH.Ucare)-1)]), 
                                                 freq = CH.Ucare$effY)) 
  
  test3sr_Cm[[k]] <- list(community = community.names.used[k],
                          test.out = test3sr(as.matrix(CH.Ucare[, 1:(ncol(CH.Ucare)-1)]), 
                                             freq = CH.Ucare$effY)) 
  
  test3sm_Cm[[k]] <- list(community = community.names.used[k],
                          test.out = test3sm(as.matrix(CH.Ucare[, 1:(ncol(CH.Ucare)-1)]), 
                                             freq = CH.Ucare$effY))
  
  test2ct_Cm[[k]] <- list(community = community.names.used[k],
                          test.out = test2ct(as.matrix(CH.Ucare[, 1:(ncol(CH.Ucare)-1)]), 
                                             freq = CH.Ucare$effY))
  
  test2cl_Cm[[k]] <- list(community = community.names.used[k],
                          test.out = test2cl(as.matrix(CH.Ucare[, 1:(ncol(CH.Ucare)-1)]), 
                                             freq = CH.Ucare$effY))
}


overall.GOF <- lapply(overall_Cm, 
                      FUN = function(x) out.list <- list(community  = x$community, 
                                                         Chi2 = x$test.out$chi2,
                                                         df = x$test.out$degree_of_freedom,
                                                         p_val = x$test.out$p_value,
                                                         c_hat = x$test.out$chi2/x$test.out$degree_of_freedom))

overall.GOF.df <- data.frame(do.call(rbind, overall.GOF))

```

#### Overall test

```{r table_overall_GOF, echo=F, include=T}
knitr::kable(overall.GOF.df, 
             digits = 2,
             col.names = c("Community", "Chi2", "df", "p val", "c-hat"),
             caption = "Table 2. Results from overall goodness-of fit",
             table.attr = "style='width:30%;'")
```

#### TEST3.SR
TEST3.SR asks "of those individuals seen either on or before occasion (i), what proportion were ever seen again?" According to the Book (Mark Book), it states that "If TEST3.SR is rejected, then this suggests that there is a difference in 'survival' among individuals, depending on whether or not they were seen for the first time either on or before occasion (i)." 

```{r test3sr, echo=FALSE, include=T}
test3sr.overall <- lapply(test3sr_Cm, 
                         FUN = function(x){out.list <- list(community  = x$community, 
                                                            stat = unname(x$test.out$test3sr["stat"]),
                                                            df = unname(x$test.out$test3sr["df"]),
                                                            p_val = unname(x$test.out$test3sr["p_val"]),
                                                            sign_test = unname(x$test.out$test3sr["sign_test"]))
                         return(out.list)})

test3sr.overall.df <- data.frame(do.call(rbind, test3sr.overall))
```


```{r table_test3sr, echo=F, include=T}
knitr::kable(test3sr.overall.df, 
             digits = 2,
             col.names = c("Community", "Stat", "df", "p val", "signed test"),
             caption = "Table 3. Results from Test3.sr, which evaluates difference in the expected time of first recapture between the ‘new’ and ‘old’ individuals captured at occasion i and seen again at least once",
             table.attr = "style='width:30%;'")
```

#### TES3.Sm

TEST3.Sm tests the hypothesis that there is no difference in the expected time of first recapture between the ‘new’ and ‘old’ individuals captured at occasion i and seen again at least once. It looks at individuals who were seen again. "Among these individuals seen again, when they were seen again does not depend on whether or not they were seen for the first time at occasion (i)."

```{r test3.sm, echo=F, include=F, cache=T}
test3sm.overall <- lapply(test3sm_Cm, 
                          FUN = function(x) out.list <- list(community  = x$community, 
                                                             stat =  unname(x$test.out$test3sm["stat"]),
                                                             df =  unname(x$test.out$test3sm["df"]),
                                                             p_val = unname(x$test.out$test3sm["p_val"])))


test3sm.overall.df <- data.frame(do.call(rbind, test3sm.overall))
```


```{r table_test3sm, echo=F, include=T}
knitr::kable(test3sm.overall.df, 
             digits = 2,
             col.names = c("Community", "Stat", "df", "p val"),
             caption = "Table 4. Results from Test3.sm, which evaluates difference in the expected time of first recapture between the ‘new’ and ‘old’ individuals captured at occasion i and seen again at least once",
             table.attr = "style='width:30%;'")
```

#### TEST2.CT

TEST2.CT tests the hypothesis that "there is no difference in the probability of being recaptured at t+1 between those captured and not captured at occasion t, conditional on presence at both occasions.  

```{r test2ct, echo=F, include=F}
test2ct.overall <- lapply(test2ct_Cm, 
                          FUN = function(x) out.list <- list(community  = x$community, 
                                                             stat =  unname(x$test.out$test2ct["stat"]),
                                                             df =  unname(x$test.out$test2ct["df"]),
                                                             p_val = unname(x$test.out$test2ct["p_val"]),
                                                             sign_test = unname(x$test.out$test2ct["sign_test"])))


test2ct.overall.df <- data.frame(do.call(rbind, test2ct.overall))
```


```{r table_test2ct, echo=F, include=T}
knitr::kable(test2ct.overall.df, 
             digits = 2,
             col.names = c("Community", "stat", "df", 
                           "p val", "signed test"),
             caption = "Table 5. Results from Test2.ct, which evaluates difference in the probability of being recaptured at t+1 between those captured and not captured at occasion t, conditional on presence at both occasions",
             table.attr = "style='width:30%;'")
```

#### TEST2.CL

TEST2.CL tests if there is no difference in the expected time of next capture between the individuals captured and not captured at occasion t conditional on presence at both occasions t and t + 2.  

```{r test2cl, echo=F, include=F, warning=F}
# The null hypothesis being tested in TEST2.CL is that there is no difference in
# the expected time of next recapture between the individuals captured and not captured at occasion i
# conditional on presence at both occasions i and i+2. To date, this test has no ‘simple’ interpretation, but
#it is a component test of the overall TEST2 fit statistic.
test2cl.overall <- lapply(test2cl_Cm, 
                          FUN = function(x) out.list <- list(community  = x$community, 
                                                             stat =  unname(x$test.out$test2cl["stat"]),
                                                             df =  unname(x$test.out$test2cl["df"]),
                                                             p_val = unname(x$test.out$test2cl["p_val"])))


test2cl.overall.df <- data.frame(do.call(rbind, test2cl.overall))
```


```{r table_test2cl, echo=F, include=T}
knitr::kable(test2cl.overall.df, 
             digits = 2,
             col.names = c("Community", "Stat", "df", "p val"),
             caption = "Table 6. Results from Test2.cl, which evaluates the expected time of next capture between the individuals captured and not captured at occasion t conditional on presence at both occasions t and t + 2",
             table.attr = "style='width:30%;'")
```

All tests indicate that almost all datasets passed the GOF tests. (except GNO, which resulted in some NAs... and PAO Test2.ct) - Look into these! 2020-12-10

For the following analyses, estimated capture probabilities that were less than 0.001 were considered unreliable and eliminated. 


### Demographic parameter estimates

```{r selected_models, echo=FALSE}
community.names <- c("BKS", "BMA", "GNO", 
                     "IES", "LSI", "MUL",
                     "PAO", "PLM")

# Because of absurdly small survival rate estimates for Phidot models, I changed them to 
# phiTSM models - they were the second best models for those communities
# BKS: Phidot_pt (2) -> PhiTSM_pt (11)
# LSI: Phidot_pt (2) -> PhiTSM_pt (11)
# MUL: Phidot_pdot (1) -> PhiTSM_pdot (10)
# PAO: Phidot_pt (2) -> PhiTSM_pt (11)
models.MARK <- data.frame(community = community.names,
                          ID = c(11, 10, 11,
                                 11, 11, 10,
                                 11, 11),
                          model = c("PhiTSM_pt", "PhiTSM_pdot", "PhiTSM_pt",
                                    "PhiTSM_pt", "PhiTSM_pt", "PhiTSM_pdot",
                                    "PhiTSM_pt", "PhiTSM_pt"))

# For GNO, Phi[TSM]p[t] resulted in near 1 survival rate estimate, so used the second best
# model, which was Phi[.]p[t]
models.MARK.old <- data.frame(community = community.names,
                          ID = c(2, 10, 2,
                                 11, 2, 1,
                                 2, 11),
                          model = c("Phidot_pt", "PhiTSM_pdot", "Phidot_pt",
                                    "PhiTSM_pt", "Phidot_pt", "Phidot_pdot",
                                    "Phidot_pt", "PhiTSM_pt"))
```


#### BKS

##### Mark
For this study area, the best model was a constant survival and time-dependent capture probabilities (phi[.]p[time], Table 7). The second best model with $\delta$AICc = 1.45 (phi[tsm]p[time]) indicated survival may be a function of time-since-marking, which is an evidence of presence of transient animals.   

```{r model_comp_BKS, echo=F}
Cm.results <- readRDS(file = paste0("RData/CJS_Cm_RMark_BKS.rds"))

BKS.models.df <- model.table(Cm.results) %>% select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model))
```


```{r table_models_BKS, echo=F, include=T}
knitr::kable(BKS.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = "Table 7. Model comparison for community BKS",
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_BKS, echo=F, include=F}
dat.1.Cm.community <- filter(dat.1.Cm, community == "BKS")
CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
n.occ <- ncol(CJS.data$data)
n.caught <- colSums(CJS.data$data)

Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_BKS.rds"))
real.estimates <- Cm.results$Phi.dot.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats <- extract.Nhats(Cm.inputs, real.estimates)

p.Nhats <- ggplot(data = N.Phi.p.hats$Nhats) +
  geom_point(aes(x = season, y = (Nhat))) +
  geom_errorbar(aes(x = season, ymin = (lcl2), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = "BKS")

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = "figures/Cm_Nhats_BKS.png",
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```

There were ```r nrow(CJS.data$data)``` turtles in the dataset. However, the numbers of turtles caught per capture occasion before ```r Cm.inputs$first.sample.date``` were insufficient to include in CMR analyses and excluded. Consequently, the capture histories of ```r nrow(Cm.inputs$CH.1)``` individual turtles from ```r Cm.inputs$first.sample.date``` to ```r max(dat.1.Cm.community$DATE)``` were used in the analysis. There were ```r n.occ``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)```. The number of captures per individual ranged from ```r min(Cm.inputs$CH$freq)``` to ```r max(Cm.inputs$CH$freq)``` with the median of ```r median(Cm.inputs$CH$freq)``` and the mean of ```r signif(mean(Cm.inputs$CH$freq), 3)```. 

Using the best model, the survival rate was estimated to be ```r signif(N.Phi.p.hats$Phihats[1,"estimate"], 3)``` (SE = ```r signif(N.Phi.p.hats$Phihats[1, "se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats$Phihats[1, "lcl"], 2)``` - ```r signif(N.Phi.p.hats$Phihats[1, "ucl"], 2)```]). 

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.p.hats$Nhats$Nhat, na.rm = T),2)``` to ```r format(signif(max(N.Phi.p.hats$Nhats$Nhat, na.rm = T), 5), big.mark = ",")``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x).


```{r plot_Nhats_BKS, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at BKS when the maximum likelihood approach and the Phi[.]p[t] model were used to analyze the capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_BKS.png"))
```

##### Bayesian

###### Using the same data and model as Mark

```{r parameter_estimates_jags_v5_BKS, echo=F, include=F}
# v5 means that the same model and dataset as what Mark selected. 
loc <- "BKS"
N.Phi.hats <- stats.Bayesian_v5(models.MARK.old, loc)

p.Nhats <- ggplot(data = N.Phi.hats$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (```r models.MARK.old %>% filter(community == loc) %>% select(model)```), the estimated mean survival rate was ```r signif(N.Phi.hats$Phihats$mean, 3)``` (SD = ```r signif(N.Phi.hats$Phihats$sd, 3)```, 95% CI = [```r signif(N.Phi.hats$Phihats$lcl, 3)``` - ```r signif(N.Phi.hats$Phihats$ucl, 2)```]).

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 3)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

```{r plot_Nhats_jags_v5_BKS, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at BKS when the Bayesian approach, the Phi[.]p[t] model, and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```

###### Using the entire data and Phi[TSM] model

The Bayesian approach allow us to use the entire dataset, even with the small numbers of captures. 
When the Bayesian approach was used to analyze the BKS dataset with the Phidot_pt model, the estimated survival rate was absurdly small (~ 0.2). Consequently, we considered the second best model (PhiTSM_pt) for the inference.

```{r parameter_estimates_jags_BKS, echo=F, include=F}
loc <- "BKS"
N.Phi.hats <- stats.Bayesian(models.MARK, loc)

p.Nhats <- ggplot(data = N.Phi.hats$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (```r models.MARK %>% filter(community == loc) %>% select(model)```), the survival rate of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[2, "mean"], 3)``` (mean, SD = ```r signif(N.Phi.hats$Gammahats[2, "sd"], 3)```, 95% CI = [```r signif(N.Phi.hats$Gammahats[2, "lcl"], 3)``` - ```r signif(N.Phi.hats$Gammahats[2, "ucl"], 2)```]). The proportion of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[1, "mean"]/N.Phi.hats$Gammahats[2, "mean"], 3)``` using the two survival rate estimates (one for transients and residents and another for residents only).

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 3)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

```{r plot_Nhats_jags_BKS, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at BKS when the Bayesian approach, the entire dataset, and the Phi[TSM]p[t] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags.png"))
```

#### BMA

##### Mark
```{r model_comp_BMA, echo=F}
Cm.results <- readRDS(file = paste0("RData/CJS_Cm_RMark_BMA.rds"))

BMA.models.df <- model.table(Cm.results)%>% select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model))
```


```{r table_models_BMA, echo=F, include=T, warning=FALSE, message=FALSE}
knitr::kable(BMA.models.df, 
             digits = 2,
             col.names = c("model", "deltaAICc"),
             row.names = F,
             caption = "Model comparison for community BMA",
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_BMA, echo=F}
dat.1.Cm.community <- filter(dat.1.Cm, community == "BMA")
CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
n.occ <- ncol(CJS.data$data)
n.caught <- colSums(CJS.data$data)

Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_BMA.rds"))
real.estimates <- Cm.results$Phi.tsm.p.dot$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats <- extract.Nhats(Cm.inputs, real.estimates)

# turn Nhats to NA when SE = 0 or SE > 1000
#Nhats.df[Nhats.df$SE_Nhat < 0.001 | Nhats.df$SE_Nhat > 1000, c("Nhat", "lcl", "ucl", "lcl2")] <- NA

p.Nhats <- ggplot(data = N.Phi.p.hats$Nhats) +
  geom_point(aes(x = season, y = (Nhat))) +
  geom_errorbar(aes(x = season, ymin = (lcl2), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = "BMA")

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = "figures/Cm_Nhats_BMA.png",
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```

The capture histories of ```r nrow(Cm.inputs$CH.1)``` individual turtles from ```r Cm.inputs$first.sample.date``` to ```r max(dat.1.Cm.community$DATE)``` were used in the analysis. There were ```r n.occ``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)```. The number of captures per individual ranged from ```r min(Cm.inputs$CH$freq)``` to ```r max(Cm.inputs$CH$freq)``` with the median of ```r median(Cm.inputs$CH$freq)``` and the mean of ```r signif(mean(Cm.inputs$CH$freq), 3)```. 

Using the best model, the survival rate of residents was estimated to be ```r signif(N.Phi.p.hats$Phihats[2,"estimate"], 3)``` (SE = ```r signif(N.Phi.p.hats$Phihats[2, "se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats$Phihats[2, "lcl"], 2)``` - ```r signif(N.Phi.p.hats$Phihats[2, "ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.p.hats$Phihats[1,"estimate"]/N.Phi.p.hats$Phihats[2,"estimate"], 3)```, using the two survival rates (one for transients and residents and another for residents only). 

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.p.hats$Nhats$Nhat, na.rm = T),2)``` to ```r format(signif(max(N.Phi.p.hats$Nhats$Nhat, na.rm = T), 5), big.mark = ",")``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x).

```{r plot_Nhats_BMA, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at BMA when the maximum likelihood approach and the Phi[TSM]p[.] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_BMA.png"))
```

##### Bayesian

###### Using the same data and model as Mark

```{r parameter_estimates_jags_v5_BMA, echo=F, include=F}
# v5 means the same data and model as what Mark selected
loc <- "BMA"
N.Phi.hats <- stats.Bayesian_v5(models.MARK.old, loc)

p.Nhats <- ggplot(data = N.Phi.hats$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (```r models.MARK.old %>% filter(community == loc) %>% select(model)```), the estimated mean survival rate of residents was ```r signif(N.Phi.hats$Gammahats[2, "mean"], 3)``` (SD = ```r signif(N.Phi.hats$Gammahats[2, "sd"], 3)```, 95% CI = [```r signif(N.Phi.hats$Gammahats[2, "lcl"], 3)``` - ```r signif(N.Phi.hats$Gammahats[2, "ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[1,"mean"]/N.Phi.hats$Gammahats[2,"mean"], 3)```, using the two survival rates (one for transients and residents and another for residents only). 

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 3)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

```{r plot_Nhats_jags_v5_BMA, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at BKS when the Bayesian approach, the Phi[TSM]p[.] model, and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```

###### Using the entire data and Phi[TSM] model

```{r parameter_estimates_jags_BMA, echo=F}
# for this location, the transient model was the best so instead of phi's we have gamma's
loc <- "BMA"
N.Phi.hats <- stats.Bayesian(models.MARK, loc)

p.Nhats <- ggplot(data = N.Phi.hats$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


I analyzed the entire dataset with the same model (Phi[TSM]p[.]) using the Bayesian approach. The estimated mean survival rate of residents was ```r signif(N.Phi.hats$Gammahats[2,"mean"], 3)``` (mean, SD = ```r signif(N.Phi.hats$Gammahats[2,"sd"], 3)```, 95% CI = [```r signif(N.Phi.hats$Gammahats[2,"lcl"], 3)``` - ```r signif(N.Phi.hats$Gammahats[2, "ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[1, "mean"]/N.Phi.hats$Gammahats[2, "mean"], 3)``` using the two survival rate estimates (one for transients and residents and another for residents only).

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats$Nhats$mean, na.rm = T), 2)``` to ```r format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")```. Results from the Bayesian approach were similar to those from the maximum likelihood approach (Mark).  

HOW WERE THESE DIFFERENT FROM THE PREVIOUS ANALYSIS USING A SMALLER DATASET?

```{r plot_Nhats_jags_BMA, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at BMA when the Bayesian approach, the Phi[TSM]p[t] model and the entire dataset were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags.png"))
```

#### GNO

##### Mark
```{r model_comp_GNO, echo=F}
Cm.results <- readRDS(file = paste0("RData/CJS_Cm_RMark_GNO.rds"))

GNO.models.df <- model.table(Cm.results)%>% select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model))
```

```{r table_models_GNO, echo=F, include=T}
knitr::kable(GNO.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = "Table. Model comparison for community GNO",
             table.attr = "style='width:30%;'")
```

Although Phi[tsm]p[t] was the best model, the mean estimate of the survival rate of residents and transients was virtually 1.0. The second best model wad only 0.93 AICc units away from the best model. Consequently, we used the second best model (Phi[.]p[t]) to make inference. 

```{r parameter_estimates_GNO, echo=F, warning=FALSE, message=FALSE}
dat.1.Cm.community <- filter(dat.1.Cm, community == "GNO")
CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
n.occ <- ncol(CJS.data$data)
n.caught <- colSums(CJS.data$data)

Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_GNO.rds"))
real.estimates <- Cm.results$Phi.dot.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats <- extract.Nhats(Cm.inputs, real.estimates)

#MODEL AVERAGING HERE.

# turn Nhats to NA when SE = 0 or SE > 1000
#Nhats.df[Nhats.df$SE_Nhat < 0.001 | Nhats.df$SE_Nhat > 5000, c("Nhat", "lcl", "ucl", "lcl2")] <- NA

p.Nhats <- ggplot(data = N.Phi.p.hats$Nhats) +
  geom_point(aes(x = season, y = (Nhat))) +
  geom_errorbar(aes(x = season, ymin = (lcl2), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = "GNO")

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = "figures/Cm_Nhats_GNO.png",
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


```{r plot_Nhats_GNO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at GNO when the maximum likelihood approach and the Phi[.]p[t] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_GNO.png"))
```

There were ```r nrow(CJS.data$data)``` turtles in the dataset. However, the numbers of turtles caught before ```r Cm.inputs$first.sample.date``` were insufficient to include in CMR analyses and excluded. Consequently, the capture histories of ```r nrow(Cm.inputs$CH.1)``` individual turtles from ```r Cm.inputs$first.sample.date``` to ```r max(dat.1.Cm.community$DATE)``` were used in the analysis. There were ```r n.occ``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)```. The number of captures per individual ranged from ```r min(Cm.inputs$CH$freq)``` to ```r max(Cm.inputs$CH$freq)``` with the median of ```r median(Cm.inputs$CH$freq)``` and the mean of ```r signif(mean(Cm.inputs$CH$freq), 3)```. 

Using the best model, the survival rate was estimated to be ```r signif(N.Phi.p.hats$Phihats[1,"estimate"], 3)``` (SE = ```r signif(N.Phi.p.hats$Phihats[1, "se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats$Phihats[1, "lcl"], 2)``` - ```r signif(N.Phi.p.hats$Phihats[1, "ucl"], 2)```]). 

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.p.hats$Nhats$Nhat, na.rm = T),2)``` to ```r format(signif(max(N.Phi.p.hats$Nhats$Nhat, na.rm = T), 5), big.mark = ",")``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x).

##### Bayesian

###### Using the same data and model as Mark
Phi[.]p[t] model needs to be run - ready in Cm_CJS_v5_jags.R 2021-04-02

```{r parameter_estimates_jags_v5_GNO, echo=F, include=F}
# v5 means the same data and model as what Mark selected
loc <- "GNO"
N.Phi.hats <- stats.Bayesian_v5(models.MARK.old, loc)

p.Nhats <- ggplot(data = N.Phi.hats$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (```r models.MARK.old %>% filter(community == loc) %>% select(model)```), the estimated survival rate was ```r signif(N.Phi.hats$Phihats$mean, 3)``` (mean, SD = ```r signif(N.Phi.hats$Phihats$sd, 3)```, 95% CI = [```r signif(N.Phi.hats$Phihats$lcl, 3)``` - ```r signif(N.Phi.hats$Phihats$ucl, 3)```]).

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 3)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

```{r plot_Nhats_jags_v5_GNO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at BKS when the Bayesian approach, the Phi[.]p[t] model, and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```

###### Using the entire data and Phi[TSM] model

```{r parameter_estimates_jags_GNO, echo=F, warning=FALSE, message=FALSE}
# for this location, the transient model was the best so instead of phi's we have gamma's
loc <- "GNO"
N.Phi.hats <- stats.Bayesian(models.MARK, loc)

p.Nhats <- ggplot(data = N.Phi.hats$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


```{r plot_Nhats_jags_GNO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at GNO when the Bayesian approach was used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags.png"))
```

Using the ```r models.MARK %>% filter(community == loc) %>% select(model)``` model, the survival rate of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[2,"mean"], 3)``` (mean, SD = ```r signif(N.Phi.hats$Gammahats[2,"sd"], 3)```, 95% CI = [```r signif(N.Phi.hats$Gammahats[2, "lcl"], 3)``` - ```r signif(N.Phi.hats$Gammahats[2, "ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[1, "mean"]/N.Phi.hats$Gammahats[2, "mean"], 3)``` using the two survival rate estimates (one for transients and residents and another for residents only).

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats$Nhats$mean, na.rm = T), 2)``` to ```r format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")``` with large uncertainty. Extreme estimates and their uncertainties were less than those from MARK. 

#### IES

##### Mark

```{r model_comp_IES, echo=F}
Cm.results <- readRDS(file = paste0("RData/CJS_Cm_RMark_IES.rds"))

IES.models.df <- model.table(Cm.results)%>% select( model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model))
```

```{r table_models_IES, echo=F, include=T}
knitr::kable(IES.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = "Table. Model comparison for community IES",
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_IES, echo=F, warning=FALSE, message=FALSE}
dat.1.Cm.community <- filter(dat.1.Cm, community == "IES")
CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
n.occ <- ncol(CJS.data$data)
n.caught <- colSums(CJS.data$data)

Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_IES.rds"))
real.estimates <- Cm.results$Phi.tsm.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats <- extract.Nhats(Cm.inputs, real.estimates)

# turn Nhats to NA when SE = 0 or SE > 1000
#Nhats.df[Nhats.df$SE_Nhat < 0.001 | Nhats.df$SE_Nhat > 1000, c("Nhat", "lcl", "ucl", "lcl2")] <- NA

p.Nhats <- ggplot(data = N.Phi.p.hats$Nhats) +
  geom_point(aes(x = season, y = (Nhat))) +
  geom_errorbar(aes(x = season, ymin = (lcl2), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = "IES")

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = "figures/Cm_Nhats_IES.png",
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


```{r plot_Nhats_IES, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients when the maximum likelihood approach and the Phi[TSM]p[t] model were used to analyze capture histories. Black filled circles indicate the means and error bars are 95% confidence intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_IES.png"))
```

There were ```r nrow(CJS.data$data)``` turtles in the dataset. However, the numbers of turtles caught before ```r Cm.inputs$first.sample.date``` were insufficient to include in CMR analyses and excluded. Consequently, the capture histories of ```r nrow(Cm.inputs$CH.1)``` individual turtles from ```r Cm.inputs$first.sample.date``` to ```r max(dat.1.Cm.community$DATE)``` were used in the analysis. There were ```r n.occ``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)```. The number of captures per individual ranged from ```r min(Cm.inputs$CH$freq)``` to ```r max(Cm.inputs$CH$freq)``` with the median of ```r median(Cm.inputs$CH$freq)``` and the mean of ```r signif(mean(Cm.inputs$CH$freq), 3)```. 

Using the best model, the survival rate was estimated to be ```r signif(N.Phi.p.hats$Phihats[1,"estimate"], 3)``` (SE = ```r signif(N.Phi.p.hats$Phihats[1, "se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats$Phihats[1, "lcl"], 2)``` - ```r signif(N.Phi.p.hats$Phihats[1, "ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.p.hats$Phihats[1,"estimate"]/N.Phi.p.hats$Phihats[2,"estimate"], 3)```, using the two survival rates (one for transients and residents and another for residents only). 

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.p.hats$Nhats$Nhat, na.rm = T),2)``` to ```r signif(max(N.Phi.p.hats$Nhats$Nhat, na.rm = T), 2)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x).

##### Bayesian

###### Using the same data and model as Mark

```{r parameter_estimates_jags_v5_IES, echo=F, include=F}
# v5 means the same data and model as what Mark selected
loc <- "IES"
N.Phi.hats <- stats.Bayesian_v5(models.MARK.old, loc)

p.Nhats <- ggplot(data = N.Phi.hats$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (```r models.MARK.old %>% filter(community == loc) %>% select(model)```), the estimated mean survival rate of residents was ```r signif(N.Phi.hats$Gammahats[2, "mean"], 3)``` (SD = ```r signif(N.Phi.hats$Gammahats[2, "sd"], 3)```, 95% CI = [```r signif(N.Phi.hats$Gammahats[2, "lcl"], 3)``` - ```r signif(N.Phi.hats$Gammahats[2, "ucl"], 2)```]).

The proportion of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[1,"mean"]/N.Phi.hats$Gammahats[2,"mean"], 3)```, using the two survival rates (one for transients and residents and another for residents only). 

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 3)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

```{r plot_Nhats_jags_v5_IES, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at IES when the Bayesian approach, the Phi[TSM]p[t] model and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```

###### Using the entire data 
```{r parameter_estimates_jags_IES, echo=F, warning=FALSE, message=FALSE}
# for this location, the transient model was the best so instead of phi's we have gamma's
loc <- "IES"
N.Phi.hats <- stats.Bayesian(models.MARK, loc)

p.Nhats <- ggplot(data = N.Phi.hats$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


```{r plot_Nhats_jags_IES, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients when the Bayesian approach, the entire dataset, and the Phi[TSM]p[t] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags.png"))
```

Using the ```r models.MARK %>% filter(community == loc) %>% select(model)``` model and the entire dataset, the survival rate of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[2,"mean"], 3)``` (mean, SD = ```r signif(N.Phi.hats$Gammahats[2,"sd"], 3)```, 95% CI = [```r signif(N.Phi.hats$Gammahats[2, "lcl"], 3)``` - ```r signif(N.Phi.hats$Gammahats[2, "ucl"], 2)```]). The proportion of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[1, "mean"]/N.Phi.hats$Gammahats[2, "mean"], 3)``` using the two survival rate estimates (one for transients and residents and another for residents only).

The proportion of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[1, "mean"]/N.Phi.hats$Gammahats[2, "mean"], 3)``` using the two survival rate estimates (one for transients and residents and another for residents only).

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats$Nhats$mean, na.rm = T), 2)``` to ```r format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

#### LSI

##### Mark

```{r model_comp_LSI, echo=F}
Cm.results <- readRDS(file = paste0("RData/CJS_Cm_RMark_LSI.rds"))

LSI.models.df <- model.table(Cm.results)%>% select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model))
```

```{r table_models_LSI, echo=F, include=T}
knitr::kable(LSI.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = "Table. Model comparison for community LSI",
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_LSI, echo=F, message=FALSE, warning=FALSE}
dat.1.Cm.community <- filter(dat.1.Cm, community == "LSI")
CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
n.occ <- ncol(CJS.data$data)
n.caught <- colSums(CJS.data$data)

Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_LSI.rds"))
real.estimates <- Cm.results$Phi.dot.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats <- extract.Nhats(Cm.inputs, real.estimates)

# turn Nhats to NA when SE = 0 or SE > 1000
#Nhats.df[Nhats.df$SE_Nhat < 0.001 | Nhats.df$SE_Nhat > 1000, c("Nhat", "lcl", "ucl", "lcl2")] <- NA

p.Nhats <- ggplot(data = N.Phi.p.hats$Nhats) +
  geom_point(aes(x = season, y = (Nhat))) +
  geom_errorbar(aes(x = season, ymin = (lcl2), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = "LSI")

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = "figures/Cm_Nhats_LSI.png",
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


```{r plot_Nhats_LSI, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at LSI when the maximum likelihood approach and the Phi[.]p[t] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_LSI.png"))
```

There were ```r nrow(CJS.data$data)``` turtles in the dataset. However, the numbers of turtles caught before ```r Cm.inputs$first.sample.date``` were insufficient to include in CMR analyses and excluded. Consequently, the capture histories of ```r nrow(Cm.inputs$CH.1)``` individual turtles from ```r Cm.inputs$first.sample.date``` to ```r max(dat.1.Cm.community$DATE)``` were used in the analysis. There were ```r n.occ``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)```. The number of captures per individual ranged from ```r min(Cm.inputs$CH$freq)``` to ```r max(Cm.inputs$CH$freq)``` with the median of ```r median(Cm.inputs$CH$freq)``` and the mean of ```r signif(mean(Cm.inputs$CH$freq), 3)```. 

Using the best model, the survival rate was estimated to be ```r signif(N.Phi.p.hats$Phihats[1,"estimate"], 3)``` (SE = ```r signif(N.Phi.p.hats$Phihats[1, "se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats$Phihats[1, "lcl"], 2)``` - ```r signif(N.Phi.p.hats$Phihats[1, "ucl"], 2)```]). 

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.p.hats$Nhats$Nhat, na.rm = T),2)``` to ```r signif(max(N.Phi.p.hats$Nhats$Nhat, na.rm = T), 2)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x).

##### Bayesian

###### Using the same data and model as Mark

```{r parameter_estimates_jags_v5_LSI, echo=F, include=F}
# v5 means the same data and model as what Mark selected
loc <- "LSI"
N.Phi.hats <- stats.Bayesian_v5(models.MARK.old, loc)

p.Nhats <- ggplot(data = N.Phi.hats$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (```r models.MARK.old %>% filter(community == loc) %>% select(model)```), the estimated survival rate was ```r signif(N.Phi.hats$Phihats$mean, 3)``` (mean, SD = ```r signif(N.Phi.hats$Phihats$sd, 3)```, 95% CI = [```r signif(N.Phi.hats$Phihats$lcl, 3)``` - ```r signif(N.Phi.hats$Phihats$ucl, 3)```]).

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 3)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

```{r plot_Nhats_jags_v5_LSI, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at LSI when the Bayesian approach, the Phi[.]p[t] model and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```

###### Using the entire data and Phi[TSM] model

Although the Phidot model was the best according to the AIC values, we used PhiTSM in the Bayesian inference because the estimated survival rate from the Phi[.] model was very small (```r signif(N.Phi.hats$Phihats$mean, 3)```). 

```{r parameter_estimates_jags_LSI, echo=F, message=FALSE, warning=FALSE}
# for this location, the transient model was the best so instead of phi's we have gamma's
loc <- "LSI"
N.Phi.hats <- stats.Bayesian(models.MARK, loc)

p.Nhats <- ggplot(data = N.Phi.hats$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


```{r plot_Nhats_jags_LSI, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at LSI including transients when the Bayesian approach, the entire dataset, and the Phi[TSM]p[t] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags.png"))
```

Using the best model (```r models.MARK %>% filter(community == loc) %>% select(model)```), the survival rate of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[2,"mean"], 3)``` (mean, SD = ```r signif(N.Phi.hats$Gammahats[2,"sd"], 3)```, 95% CI = [```r signif(N.Phi.hats$Gammahats[2, "lcl"], 3)``` - ```r signif(N.Phi.hats$Gammahats[2, "ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[1, "mean"]/N.Phi.hats$Gammahats[2, "mean"], 3)``` using the two survival rate estimates (one for transients and residents and another for residents only).

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats$Nhats$mean, na.rm = T), 2)``` to ```r format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

#### MUL

##### Mark

```{r model_comp_MUL, echo=F}
Cm.results <- readRDS(file = paste0("RData/CJS_Cm_RMark_MUL.rds"))

MUL.models.df <- model.table(Cm.results)%>% select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model))
```

```{r table_models_MUL, echo=F, include=T}
knitr::kable(MUL.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = "Table. Model comparison for community MUL",
             table.attr = "style='width:30%;'")
```

```{r parameter_estimates_MUL, echo=F, message=FALSE, warning=FALSE}
dat.1.Cm.community <- filter(dat.1.Cm, community == "MUL")
CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
n.occ <- ncol(CJS.data$data)
n.caught <- colSums(CJS.data$data)

Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_MUL.rds"))
real.estimates <- Cm.results$Phi.dot.p.dot$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats <- extract.Nhats(Cm.inputs, real.estimates)

# turn Nhats to NA when SE = 0 or SE > 1000
#Nhats.df[Nhats.df$SE_Nhat < 0.001 | Nhats.df$SE_Nhat > 1000, c("Nhat", "lcl", "ucl", "lcl2")] <- NA

p.Nhats <- ggplot(data = N.Phi.p.hats$Nhats) +
  geom_point(aes(x = season, y = (Nhat))) +
  geom_errorbar(aes(x = season, ymin = (lcl2), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = "MUL")

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = "figures/Cm_Nhats_MUL.png",
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


```{r plot_Nhats_MUL, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at MUL when the maximum likelihood approach and the Phi[.]p[.] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_MUL.png"))
```

There were ```r nrow(CJS.data$data)``` turtles in the dataset. However, the numbers of turtles caught before ```r Cm.inputs$first.sample.date``` were insufficient to include in CMR analyses and excluded. Consequently, the capture histories of ```r nrow(Cm.inputs$CH.1)``` individual turtles from ```r Cm.inputs$first.sample.date``` to ```r max(dat.1.Cm.community$DATE)``` were used in the analysis. There were ```r n.occ``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)```. The number of captures per individual ranged from ```r min(Cm.inputs$CH$freq)``` to ```r max(Cm.inputs$CH$freq)``` with the median of ```r median(Cm.inputs$CH$freq)``` and the mean of ```r signif(mean(Cm.inputs$CH$freq), 3)```. 

Using the best model, the survival rate was estimated to be ```r signif(N.Phi.p.hats$Phihats[1,"estimate"], 3)``` (SE = ```r signif(N.Phi.p.hats$Phihats[1, "se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats$Phihats[1, "lcl"], 2)``` - ```r signif(N.Phi.p.hats$Phihats[1, "ucl"], 2)```]). 

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.p.hats$Nhats$Nhat, na.rm = T),2)``` to ```r signif(max(N.Phi.p.hats$Nhats$Nhat, na.rm = T), 2)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x).

##### Bayesian

###### Using the same data and model as Mark

```{r parameter_estimates_jags_v5_MUL, echo=F, include=F}
# v5 means the same data and model as what Mark selected
loc <- "MUL"
N.Phi.hats <- stats.Bayesian_v5(models.MARK.old, loc)

p.Nhats <- ggplot(data = N.Phi.hats$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (```r models.MARK.old %>% filter(community == loc) %>% select(model)```), the estimated survival rate was ```r signif(N.Phi.hats$Phihats$mean, 3)``` (mean, SD = ```r signif(N.Phi.hats$Phihats$sd, 3)```, 95% CI = [```r signif(N.Phi.hats$Phihats[2, "lcl"], 3)``` - ```r signif(N.Phi.hats$Phihats[2, "ucl"], 2)```]).

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 3)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

```{r plot_Nhats_jags_v5_MUL, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at MUL when the Bayesian approach, the Phi[.]p[.] model, and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```

###### Using the entire data and Phi[TSM] model

```{r parameter_estimates_jags_MUL, echo=F, message=FALSE, warning=FALSE}
loc <- "MUL"
N.Phi.hats <- stats.Bayesian(models.MARK, loc)

p.Nhats <- ggplot(data = N.Phi.hats$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


```{r plot_Nhats_jags_MUL, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at MUL when the Bayesian approach, the Phi[TSM]p[.] model, and the entire dataset were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags.png"))
```

Using the ```r models.MARK %>% filter(community == loc) %>% select(model)``` model, the survival rate of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[2,"mean"], 3)``` (mean, SD = ```r signif(N.Phi.hats$Gammahats[2,"sd"], 3)```, 95% CI = [```r signif(N.Phi.hats$Gammahats[2, "lcl"], 3)``` - ```r signif(N.Phi.hats$Gammahats[2, "ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[1, "mean"]/N.Phi.hats$Gammahats[2, "mean"], 3)``` using the two survival rate estimates (one for transients and residents and another for residents only).

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats$Nhats$mean, na.rm = T), 2)``` to ```r format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

#### PAO

##### Mark
```{r model_comp_PAO, echo=F}
Cm.results <- readRDS(file = paste0("RData/CJS_Cm_RMark_PAO.rds"))

PAO.models.df <- model.table(Cm.results)%>% select(model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model))
```


```{r table_models_PAO, echo=F, include=T}
knitr::kable(PAO.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = "Table. Model comparison for community PAO",
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_PAO, echo=F, message=FALSE, warning=FALSE}
dat.1.Cm.community <- filter(dat.1.Cm, community == "PAO")
CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
n.occ <- ncol(CJS.data$data)
n.caught <- colSums(CJS.data$data)

Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_PAO.rds"))
real.estimates <- Cm.results$Phi.dot.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats <- extract.Nhats(Cm.inputs, real.estimates)

# turn Nhats to NA when SE = 0 or SE > 1000
#Nhats.df[Nhats.df$SE_Nhat < 0.001 | Nhats.df$SE_Nhat > 5000, c("Nhat", "lcl", "ucl", "lcl2")] <- NA

p.Nhats <- ggplot(data = N.Phi.p.hats$Nhats) +
  geom_point(aes(x = season, y = (Nhat))) +
  geom_errorbar(aes(x = season, ymin = (lcl2), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = "PAO")

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = "figures/Cm_Nhats_PAO.png",
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


```{r plot_Nhats_PAO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at PAO when the maximum likelihood approach and the Phi[.]p[t] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_PAO.png"))
```

The capture histories of ```r nrow(Cm.inputs$CH.1)``` individual turtles from ```r Cm.inputs$first.sample.date``` to ```r max(dat.1.Cm.community$DATE)``` were used in the analysis. There were ```r n.occ``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)```. The number of captures per individual ranged from ```r min(Cm.inputs$CH$freq)``` to ```r max(Cm.inputs$CH$freq)``` with the median of ```r median(Cm.inputs$CH$freq)``` and the mean of ```r signif(mean(Cm.inputs$CH$freq), 3)```. 

Using the best model, the survival rate was estimated to be ```r signif(N.Phi.p.hats$Phihats[1,"estimate"], 3)``` (SE = ```r signif(N.Phi.p.hats$Phihats[1, "se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats$Phihats[1, "lcl"], 2)``` - ```r signif(N.Phi.p.hats$Phihats[1, "ucl"], 2)```]). 

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.p.hats$Nhats$Nhat, na.rm = T),2)``` to ```r format(signif(max(N.Phi.p.hats$Nhats$Nhat, na.rm = T), 5), big.mark = ",")``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x).

##### Bayesian

###### Using the same data and model as Mark

```{r parameter_estimates_jags_v5_PAO, echo=F, include=F}
# v5 means the same data and model as what Mark selected
loc <- "PAO"
N.Phi.hats <- stats.Bayesian_v5(models.MARK.old, loc)

p.Nhats <- ggplot(data = N.Phi.hats$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (```r models.MARK.old %>% filter(community == loc) %>% select(model)```), the estimated survival rate was ```r signif(N.Phi.hats$Phihats$mean, 3)``` (mean, SD = ```r signif(N.Phi.hats$Phihats$sd, 3)```, 95% CI = [```r signif(N.Phi.hats$Phihats$lcl, 3)``` - ```r signif(N.Phi.hats$Phihats$ucl, 3)```]).

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 3)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

```{r plot_Nhats_jags_v5_PAO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles at PAO when the Bayesian approach, the Phi[.]p[t] model and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```

###### Using the entire data and Phi[TSM] model

```{r parameter_estimates_jags_PAO, echo=F, message=FALSE, warning=FALSE}
loc <- "PAO"
N.Phi.hats <- stats.Bayesian(models.MARK, loc)

p.Nhats <- ggplot(data = N.Phi.hats$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


```{r plot_Nhats_jags_PAO, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at PAO when the Bayesian approach, the Phi[TSM]p[t] model and the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags.png"))
```

Using the ```r models.MARK %>% filter(community == loc) %>% select(model)``` model, the survival rate of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[2,"mean"], 3)``` (mean, SD = ```r signif(N.Phi.hats$Gammahats[2,"sd"], 3)```, 95% CI = [```r signif(N.Phi.hats$Gammahats[2, "lcl"], 3)``` - ```r signif(N.Phi.hats$Gammahats[2, "ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[1, "mean"]/N.Phi.hats$Gammahats[2, "mean"], 3)``` using the two survival rate estimates (one for transients and residents and another for residents only).

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats$Nhats$mean, na.rm = T), 2)``` to ```r format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

#### PLM

##### Mark

```{r model_comp_PLM, echo=F}
Cm.results <- readRDS(file = paste0("RData/CJS_Cm_RMark_PLM.rds"))

PLM.models.df <- model.table(Cm.results)%>% select( model, DeltaAICc) %>% 
  mutate(model = paren2bracket(model))
```

```{r table_models_PLM, echo=F, include=T}
knitr::kable(PLM.models.df, 
             digits = 2,
             col.names = c("model", "DeltaAICc"),
             row.names = F,
             caption = "Table. Model comparison for community PLM",
             table.attr = "style='width:30%;'")
```


```{r parameter_estimates_PLM, echo=F, message=FALSE, warning=FALSE}
dat.1.Cm.community <- filter(dat.1.Cm, community == "PLM")
CJS.data <- dat2CJS(dat.1.Cm.community, save.file = FALSE)
n.occ <- ncol(CJS.data$data)
n.caught <- colSums(CJS.data$data)

Cm.inputs <- readRDS(file = paste0("RData/CJS_Cm_RMark_input_PLM.rds"))

real.estimates <- Cm.results$Phi.tsm.p.t$results$real %>% rownames_to_column("parameter")

N.Phi.p.hats <- extract.Nhats(Cm.inputs, real.estimates)

# turn Nhats to NA when SE = 0 or SE > 1000
#Nhats.df[Nhats.df$SE_Nhat < 0.001 | Nhats.df$SE_Nhat > 1000, c("Nhat", "lcl", "ucl", "lcl2")] <- NA

p.Nhats <- ggplot(data = N.Phi.p.hats$Nhats) +
  geom_point(aes(x = season, y = (Nhat))) +
  geom_errorbar(aes(x = season, ymin = (lcl2), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = "PLM")

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = "figures/Cm_Nhats_PLM.png",
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


```{r plot_Nhats_PLM, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at PLM when the maximum likelihood approach and the Phi[TSM]p[t] model were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% confidence intervals (CI)"}
knitr::include_graphics(paste0("figures/Cm_Nhats_PLM.png"))
```

There were ```r nrow(CJS.data$data)``` turtles in the dataset. However, the numbers of turtles caught before ```r Cm.inputs$first.sample.date``` were insufficient to include in CMR analyses and excluded. Consequently, the capture histories of ```r nrow(Cm.inputs$CH.1)``` individual turtles from ```r Cm.inputs$first.sample.date``` to ```r max(dat.1.Cm.community$DATE)``` were used in the analysis. There were ```r n.occ``` capture occasions and the number of captured turtles per capture occasion ranged from ```r min(n.caught, na.rm = T)``` to ```r max(n.caught, na.rm = T)```. The number of captures per individual ranged from ```r min(Cm.inputs$CH$freq)``` to ```r max(Cm.inputs$CH$freq)``` with the median of ```r median(Cm.inputs$CH$freq)``` and the mean of ```r signif(mean(Cm.inputs$CH$freq), 3)```. 

Using the best model, the survival rate was estimated to be ```r signif(N.Phi.p.hats$Phihats[1,"estimate"], 3)``` (SE = ```r signif(N.Phi.p.hats$Phihats[1, "se"], 3)```, 95% CI = [```r signif(N.Phi.p.hats$Phihats[1, "lcl"], 2)``` - ```r signif(N.Phi.p.hats$Phihats[1, "ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.p.hats$Phihats[1,"estimate"]/N.Phi.p.hats$Phihats[2,"estimate"], 3)```, using the two survival rates (one for transients and residents and another for residents only). 

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.p.hats$Nhats$Nhat, na.rm = T),2)``` to ```r format(max(N.Phi.p.hats$Nhats$Nhat, na.rm = T), big.mark = ",")``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x).

##### Bayesian

###### Using the same data and model as Mark

```{r parameter_estimates_jags_v5_PLM, echo=F, include=F}
# v5 means the same data and model as what Mark selected
loc <- "PLM"
N.Phi.hats <- stats.Bayesian_v5(models.MARK.old, loc)

p.Nhats <- ggplot(data = N.Phi.hats$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

#format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")
```

Using the best model (```r models.MARK.old %>% filter(community == loc) %>% select(model)```), the estimated mean survival rate of residents was ```r signif(N.Phi.hats$Gammahats[2, "mean"], 3)``` (SD = ```r signif(N.Phi.hats$Gammahats[2, "sd"], 3)```, 95% CI = [```r signif(N.Phi.hats$Gammahats[2, "lcl"], 3)``` - ```r signif(N.Phi.hats$Gammahats[2, "ucl"], 2)```]).

The proportion of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[1,"mean"]/N.Phi.p.hats$Gammahats[2,"mean"], 3)```, using the two survival rates (one for transients and residents and another for residents only). 

Estimated mean seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats$Nhats$mean, na.rm = T), 2)``` to ```r signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 3)``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

```{r plot_Nhats_jags_v5_PLM, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at PLM when the Bayesian approach, the Phi[TSM]p[t], the same data as in the maximum likelihood approach were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags_v5.png"))
```

###### Using the entire data

```{r parameter_estimates_jags_PLM, echo=F, message=FALSE, warning=FALSE}
loc <- "PLM"
N.Phi.hats <- stats.Bayesian(models.MARK, loc)

p.Nhats <- ggplot(data = N.Phi.hats$Nhats) +
  geom_point(aes(x = season, y = (mean))) +
  geom_errorbar(aes(x = season, ymin = (lcl), ymax = (ucl))) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)") +
  labs(title = loc)

if (save.fig)
  ggsave(plot = p.Nhats, 
         filename = paste0("figures/Cm_Nhats_", loc, "_jags.png"),
         height = fig.height, width = fig.width,
         device = "png", dpi = 600)

```


```{r plot_Nhats_jags_PLM, echo=FALSE, cache=TRUE, warning = FALSE, message = FALSE, fig.cap="Figure. Estimated abundance of green turtles including transients at PLM when the Bayesian approach, the Phi[TSM]p[t], and the entire data were used to analyze capture histories. Filled circles indicate means and error bars indicate 95% credible intervals (CI)."}
knitr::include_graphics(paste0("figures/Cm_Nhats_", loc, "_jags.png"))
```

Using the ```r models.MARK %>% filter(community == loc) %>% select(model)``` model, the survival rate of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[2,"mean"], 3)``` (mean, SD = ```r signif(N.Phi.hats$Gammahats[2,"sd"], 3)```, 95% CI = [```r signif(N.Phi.hats$Gammahats[2,"lcl"], 3)``` - ```r signif(N.Phi.hats$Gammahats[2,"ucl"], 2)```]). 

The proportion of residents was estimated to be ```r signif(N.Phi.hats$Gammahats[1, "mean"]/N.Phi.hats$Gammahats[2, "mean"], 3)``` using the two survival rate estimates (one for transients and residents and another for residents only).

Estimated seasonal abundance fluctuated over time, which ranged from ```r signif(min(N.Phi.hats$Nhats$mean, na.rm = T), 2)``` to ```r format(signif(max(N.Phi.hats$Nhats$mean, na.rm = T), 5), big.mark = ",")``` with large uncertainty, which likely resulted from small numbers of recaptures (Figure x). These estimates were significantly lower than those from MARK. 

