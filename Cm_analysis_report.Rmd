---
title: "Preliminary analyses of capture-recapture data for green turtles"
author: "Tomo Eguchi"
date: "7/8/2020"
output: word_document
---

```{r setup, include=FALSE}
rm(list=ls())

knitr::opts_chunk$set(echo = TRUE)
library(jagsUI)
library(tidyverse)
library(lubridate)
library(reshape)
library(bayesplot)
library(ggridges)
library(RMark)
library(loo)

save.fig <- F

source("Mancini_functions.R")

```

This document summarizes preliminary analyses of capture-recapture data for green turtles.  The data were used to investigate somatic growth patterns and to estimate survival rates and abundance.  Growths patterns of green turtles were determined by fitting the von Bertalanffy function to repeated measurements of CCL.  To estimate survival and abundance, the Cormack-Jolly-Seber capture-mark-recapture (CJS CMR) model was fitted to the capture-recapture histories. In the following, I will summarize the preliminary results of the analyses.  

All statistical analyses were conducted using the R statistical environment (v. 3.6.1, R Development Team).

# Somatic growth
## Methods
I used a Bayesian version of von Bertalanffy growth model, which was developed for fish and invertebrates (Laslett et al. 2002, Eveson et al. 2007, Zhang et al, 2009) and used for green turtles (Eguchi et al. 2010). The model was fitted using JAGS (Plummer 2018) via the jagsUI package.

There are two growth parameters in the von Bertalanffy function: L_inf and k.  L_inf is considered as the asymptotic size and k is the growth parameter.  Larger k values correspond to faster growths.  Four models were considered based on the assumptions of  the two parameters.  Each parameter was considered either "random" or "fixed."  When a parameter is "random," it comes from a distribution and each individual receives a unique value according to the distribution.  The mean and variance of the distribution are estimated as well as a value for each individual.  When a parameter is fixed, all individuals will have the same value.  The last parameter of the function is t_0, which is considered as the theoretical age at length 0.  In the Bayesian approach, the parameter t_0 is replaced with one that is interpreted as the age at tagging minus t_0 (A).

I used the leave-one-out information criteria (LOOIC) to compare the performance of the four models (Vehtari et al. 2017))

```{r load_data, include=FALSE, echo=FALSE, cache=T}
dat.1 <- get.data("data/GTC_20190725_Tomo_v2.csv")
dat.1.Cm <- filter(dat.1, species == "Cm")

ID.CCLna <- dat.1.Cm[which(is.na(dat.1.Cm$CCL)),]

# check to see how many times each one of these were caught. 
n.caps.ID.CCLna <- c(nrow(dat.1.Cm[dat.1.Cm$ID %in% lapply(ID.CCLna[,1], as.character)$ID[1],]),
                     nrow(dat.1.Cm[dat.1.Cm$ID %in% lapply(ID.CCLna[,1], as.character)$ID[2],]),
                     nrow(dat.1.Cm[dat.1.Cm$ID %in% lapply(ID.CCLna[,1], as.character)$ID[3],]))

# some have only NAs so we get warnings
dat.1.Cm %>% select(ID, CCL) %>% 
  na.omit() %>%
  group_by(ID) %>%
  summarise(min_CCL = min(CCL, na.rm = T)) %>%
  filter(!is.infinite(min_CCL)) -> data.CCL

CJS.data <- dat2CJS(dat.1.Cm, save.file = FALSE)

CJS.data$data %>% rownames_to_column(var = "ID") -> data.CJS

data.CCL  %>% left_join(data.CJS, by = "ID") %>%
  select(min_CCL) -> cov.CCL

jags.data <- vonBert.jags.data(dat.1, "Cm")

jm.RLinf_Rk.Cm <- readRDS("RData/Rlinf_Rk_Cm.rds")
jm.RLinf_Fk.Cm <- readRDS("RData/Rlinf_Fk_Cm.rds")
jm.FLinf_Rk.Cm <- readRDS("RData/Flinf_Rk_Cm.rds")
jm.FLinf_Fk.Cm <- readRDS("RData/Flinf_Fk_Cm.rds")


LOOIC.RLinf_Rk.Cm <- readRDS("RData/LOO_Rlinf_Rk_Cm.rds")
LOOIC.RLinf_Fk.Cm <- readRDS("RData/LOO_Rlinf_Fk_Cm.rds")
LOOIC.FLinf_Rk.Cm <- readRDS("RData/LOO_Flinf_Rk_Cm.rds")
LOOIC.FLinf_Fk.Cm <- readRDS("RData/LOO_Flinf_Fk_Cm.rds")

LOOIC.DIC.Cm <- data.frame(model = c("RLinf_Rk", "RLinf_Fk", "FLinf_Rk", "FLinf_Fk"),
                           LOOIC = c(LOOIC.RLinf_Rk.Cm$loo.out$estimates["looic", "Estimate"],
                                     LOOIC.RLinf_Fk.Cm$loo.out$estimates["looic", "Estimate"],
                                     LOOIC.FLinf_Rk.Cm$loo.out$estimates["looic", "Estimate"],
                                     LOOIC.FLinf_Fk.Cm$loo.out$estimates["looic", "Estimate"]),
                           SE = c(LOOIC.RLinf_Rk.Cm$loo.out$estimates["looic", "SE"],
                                  LOOIC.RLinf_Fk.Cm$loo.out$estimates["looic", "SE"],
                                  LOOIC.FLinf_Rk.Cm$loo.out$estimates["looic", "SE"],
                                  LOOIC.FLinf_Fk.Cm$loo.out$estimates["looic", "SE"]),
                           DIC = c(jm.RLinf_Rk.Cm$DIC, 
                                   jm.RLinf_Fk.Cm$DIC, 
                                   jm.FLinf_Rk.Cm$DIC, 
                                   jm.FLinf_Fk.Cm$DIC),
                           max.Rhat = c(max(jm.RLinf_Rk.Cm$summary %>% as.data.frame() %>% select(Rhat)),
                                        max(jm.RLinf_Fk.Cm$summary %>% as.data.frame() %>% select(Rhat)),
                                        max(jm.FLinf_Rk.Cm$summary %>% as.data.frame() %>% select(Rhat)),
                                        max(jm.FLinf_Fk.Cm$summary %>% as.data.frame() %>% select(Rhat)))) %>%
  arrange(by = LOOIC)

#LOOIC.DIC.Cm
```

# Results
There were ```r length(unique(dat.1.Cm$ID))``` individuals in the dataset, where CCL records were missing from ```r sum(is.na(dat.1.Cm$CCL))``` captures.  Three individuals were caught once (```r lapply(ID.CCLna[,1], as.character)$ID[1]```  on ```r ID.CCLna[1, "DATE"]```, ```r lapply(ID.CCLna[,1], as.character)$ID[2]```  on ```r ID.CCLna[2, "DATE"]```, and ```r lapply(ID.CCLna[,1], as.character)$ID[3]```  on ```r ID.CCLna[3, "DATE"]``` ).  These turtles were excluded from the analysis.        

## Size distribution
CCL at first captures ranged from ```r min(cov.CCL$min_CCL)``` cm to ```r max(cov.CCL$min_CCL)``` cm (mean of ```r signif(mean(dat.1.Cm$CCL, na.rm = T), 4)``` cm).  

```{r CCL_histo, warning=FALSE, echo=FALSE, include=F}

p.CCL.histo <- ggplot(data = cov.CCL) +
  geom_histogram(aes(x = min_CCL),
                 binwidth = 3) +
  xlab("CCL at first capture (cm)")

if (save.fig)
  ggsave(filename = "figures/Cm_CCL_histo.png", plot = p.CCL.histo,
         device = "png", dpi = 600)
```

```{r plot_CCL_histo, echo=FALSE, cache=TRUE, fig.cap = "Figure 1. The distribution of CCL when turtles were caught first time."}
knitr::include_graphics(paste0("figures/Cm_CCL_histo.png"))
```

The size distribution of turtles at the first capture indicated that the majority of green turtles in this area recruited as juveniles, although some were large.  There were pulses of small juveniles (~ 55 cm) found in some years (e.g., 2001-2005, 2008, 2013-2015; Figure 2).

```{r SCL change, echo=FALSE, warning=FALSE, message = FALSE}
dat.1.Cm %>% mutate(Yr = year(DATE)) -> dat.1.Cm

# dat.1.Cm %>% mutate(Year.Group = if_else(Yr>=2015, "2015-2019",
#                                          if_else(Yr>=2010 & Yr<=2014, "2010-2014",
#                                                  if_else(Yr>=2005 & Yr <= 2009, "2005-2009", "2000-2004")))) -> dat.1.Cm
                    

dat.1.Cm %>% group_by(ID) %>% 
  summarize(firstCap = first(DATE),
            firstGroup = first(Yr),
            firstCCL = first(CCL)) %>%
  na.omit() -> firstcap_only

p.change.CCL <- ggplot(data=firstcap_only, 
       aes(x = firstCCL, 
           y = as.factor(firstGroup)), na.rm =T)+
  geom_density_ridges2(fill="forestgreen",
                       jittered_points = T,
                       position = position_points_jitter(height = 0),
                       alpha = 0.5)+
  coord_flip() +
  theme(axis.text.x = element_text(angle = 45,
                                   vjust = 0.5)) + 
  labs(title="Change in size distribution of green turtles (first captures)", 
       x="CCL (cm)", y = element_text())

if (save.fig)
  ggsave(filename = "figures/Cm_ChangeInSize.png", 
         plot = p.change.CCL,
         device = "png", dpi = 600, 
         width = 6.29, height = 3.68, units = "in")

#p1
```


```{r plot_change_CCL, echo=FALSE, cache=TRUE, fig.cap= "Figure 2. Change in size distributions of green turtles that were caught first time"}
knitr::include_graphics(paste0("figures/Cm_ChangeInSize.png"))
```


```{r sizeBySeason, echo=FALSE, include=FALSE, cache=T}
dat.1.Cm %>% select(season, CCL) %>%
  group_by(season) %>%
  na.omit() -> dat.1.Cm.CCL 

dat.1.Cm %>% select(season, CCL) %>%
  group_by(season) %>%
  summarise(mean = mean(CCL, na.rm = T),
            n = length(CCL),
            SE = sqrt(var(CCL))/sqrt(length(CCL)),
            Low = mean - 2 * SE,
            High = mean + 2 * SE,
            min = min(CCL, na.rm = T),
            max = max(CCL, na.rm = T)) -> CCL.mean.season.Cm

CCL.mean.season.Cm[is.na(CCL.mean.season.Cm$SE), "SE"] <- 0
CCL.mean.season.Cm[is.na(CCL.mean.season.Cm$Low), "Low"] <- CCL.mean.season.Cm[is.na(CCL.mean.season.Cm$Low), "mean"]
CCL.mean.season.Cm[is.na(CCL.mean.season.Cm$High), "High"] <- CCL.mean.season.Cm[is.na(CCL.mean.season.Cm$High), "mean"]

p.size.by.season <- ggplot(data = dat.1.Cm.CCL) +
  geom_boxplot(aes(x = season, y = CCL)) +
  # geom_point(aes(x = season, 
  #                y = mean)) + 
  # geom_errorbar(aes(x = season,
  #                   ymin = Low,
  #                   ymax = High)) + 
  # geom_point(aes(x = season, y = min),
  #            color = "red") + 
  # geom_point(aes(x = season, y = max),
  #            color = "red") +
  # ylab("Mean CCL +/- 2SE (cm)") +
  # geom_text(data = CCL.mean.season.Cm, 
  #           aes(x = season, y = 120,
  #               label = paste0("(", n, ")")),
  #           size = 2.5) +
  theme(axis.text.x = element_text(angle = 90,
                                   vjust = 0.5)) + 
  ylab("CCL (cm)")

if (save.fig)
  ggsave(plot = p.size.by.season, filename = "figures/Cm_SizeBySeason.png",
         device = "png", dpi = 600)
```


```{r plot_SizeBySeason, echo=FALSE, cache=TRUE, fig.cap="Figure 3. Season-specific size distributions of green turtles"}
knitr::include_graphics(paste0("figures/Cm_SizeBySeason.png"))
```


## von Bertalanffy growth function

When the von Bertalanffy growth function was fitted to the length data, convergence was reached for all models according to the Gelman-Rubin Rhat statistic (Rhat < 1.1) and visual inspections of Markov chain Monte Carlo simulations (Appendix).  

According to the LOOIC, the random L_inf and fixed k model was the best.  The median of the distribution of L_inf was ```r signif(jm.RLinf_Fk.Cm$q50$LinfMu, 2)``` cm (95% CI = ```r signif(jm.RLinf_Fk.Cm$q2.5$LinfMu, 2)``` cm - ```r signif(jm.RLinf_Fk.Cm$q97.5$LinfMu, 2)``` cm).  The median growth coefficient (k) was ```r signif(jm.RLinf_Fk.Cm$q50$k, 2)```  (95% CI = ```r signif(jm.RLinf_Fk.Cm$q2.5$k, 2)``` - ```r signif(jm.RLinf_Fk.Cm$q97.5$k, 2)```).  The median of A parameter (age at tagging minus the theoretical age at length = 0), ranged from ```r signif(min(jm.RLinf_Fk.Cm$q50$A), 3)``` to ```r signif(max(jm.RLinf_Fk.Cm$q50$A), 3)``` with the mean of ```r signif(mean(jm.RLinf_Fk.Cm$q50$A), 3)```.  All these estimates indicated slow growths of green turtles in this environment. (I think a more typical value is k = 0.06 - 0.08)

```{r plot_vB,  echo=FALSE, include=F, cache=T}
k.samples <- extract.samples("k", jm.RLinf_Fk.Cm$samples)

time.vec <- 0:59

unique.ID <- jags.data$ID

time.mat <- L_Exp.med <- L_Exp.lo <- L_Exp.hi <- matrix(ncol = length(unique.ID), nrow = length(time.vec))

t <- i <- 1
for (i in 1:length(unique.ID)){
  A.samples <- extract.samples(paste0("A[", i, "]"), jm.RLinf_Fk.Cm$samples)
  Linf.samples <- extract.samples(paste0("Linf[", i, "]"), jm.RLinf_Fk.Cm$samples)
  for (t in 1:length(time.vec)){
    L_Exp <-  Linf.samples * (1.0 - exp(-k.samples * (A.samples + time.vec[t])))
    L_Exp.med[t,i] <- quantile(L_Exp, 0.5)
    L_Exp.lo[t,i] <- quantile(L_Exp, 0.025)
    L_Exp.hi[t,i] <- quantile(L_Exp, 0.975)
    
    time.mat[t,i] <- quantile(A.samples + time.vec[t], 0.5)
  }

}

colnames(L_Exp.med) <- unique.ID
L_Exp_long <- melt(L_Exp.med)
colnames(L_Exp_long) <- c("time1", "ID", "CCL")

colnames(L_Exp.lo) <- unique.ID
L_Exp.lo_long <- melt(L_Exp.lo)
colnames(L_Exp.lo_long) <- c("time1", "ID", "CCL")

colnames(L_Exp.hi) <- unique.ID
L_Exp.hi_long <- melt(L_Exp.hi)
colnames(L_Exp.hi_long) <- c("time1", "ID", "CCL")

colnames(time.mat) <- unique.ID
time_long <- melt(time.mat)
colnames(time_long) <- c("time1", "ID", "Years")

L_Exp_long$Years <- time_long$Years
L_Exp.lo_long$Years <- time_long$Years
L_Exp.hi_long$Years <- time_long$Years

p.vB.fit <- ggplot() + 
  geom_path(data = L_Exp_long,
            aes(x = Years, y = CCL, color = ID)) +
  geom_path(data = L_Exp.lo_long,
            aes(x = Years, y = CCL, color = ID),
            linetype = 2) +
  geom_path(data = L_Exp.hi_long,
            aes(x = Years, y = CCL, color = ID),
            linetype = 2) +
  theme(legend.position = "none")

if (save.fig)
  ggsave(plot = p.vB.fit,filename = "figures/Cm_vB_fit.png",
         device = "png", dpi = 600)
```


```{r plot_vB_fit, echo=FALSE, cache=TRUE, fig.cap="Figure 4. Fitted von Bertalanffy growth model"}
knitr::include_graphics(paste0("figures/Cm_vB_fit.png"))
```

## Survival and abundance

I fitted Cormack-Jolly-Seber (CJS) models to the capture-recapture histories for this preliminary analyses.  It may be worthwhile to explore other models, such as multi-state and robust-design, in the future.  Briefly, the CJS model uses the capture history of each individual without assuming that the population is closed. There are two main parameters in the basic model; survival rate (phi) and capture/recapture probability (p).  The abundance may be estimated through the Horvitz-Thompson estimator, where the number of captured individuals per temporal sampling period is divided by the estimated capture probability for that time period. The estimated survival rate should be considered as an apparent survival rate as the permanent emigrant is considered as dead.  Effects of transients, however, can be determined.   

The basic model can be extended to accommodate various modifications, such as time-dependent survival rates, time-dependent capture probability, covariate-dependent survival rates and capture probabilities.    

### Methods

```{r CMR_data, include=FALSE, echo=FALSE, cache=T}
dat.1 <- get.data("data/GTC_20190725_Tomo_v2.csv")

dat.1 %>% filter(species == "Cm") -> dat.1.Cm
CJS.data <- dat2CJS(dat.1.Cm, save.file = FALSE)

CJS.data$data %>% rownames_to_column(var = "ID") -> data.CJS

# Use CCL as a covariate as only three were missed (these may be recaptures also).
dat.1.Cm %>% select(ID, CCL) %>% group_by(ID) %>%
  summarise(min_CCL = min(CCL, na.rm = T)) %>%
  filter(!is.infinite(min_CCL)) -> data.CCL

dat.1.Cm %>% select(season, "DATE") %>% 
  group_by(season) %>% #-> tmp3
  summarise(effort = n_distinct(DATE)) -> effort.season
  
dat.1.CCL <- dat2CJS_covCCL(dat.1.Cm)
data.CCL %>% left_join(dat.1.CCL, by = "ID") %>%
  select(-min_CCL) -> dat.2.CCL

cm.results <- readRDS(file = "RData/CJS_Cm_RMark.rds")
mark.table <- model.table(cm.results) %>% rownames_to_column(var = "ID")

mark.table %>% select(ID, model, DeltaAICc) -> mark.table.2

```

Capture history data were pooled by sampling seasons (summer and winter). Consequently, multiple captures within each season were treated as one capture. 

I considered several possible models for this analysis. For survival rates, they were treated as either constant, affected by transients (time-since-marking; TSM), a function of age class (immature < 81.6 cm CCL) or a function of size (CCL).  For capture probabilities, they were treated as either constant, time dependent, different between the first and subsequent captures (trap response), or a function of effort. A total of 14 models were fitted to the data (Table 1).

```{r model_defs, echo=F, include=T}
knitr::kable(mark.table %>% select(ID, Phi, p, model) %>% arrange(by = as.numeric(ID)), 
             digits = 2,
             caption = "Table 1. Definitions of 14 CJS models fitted to CMR data of green turtles. ",
             table.attr = "style='width:30%;'")
```

Analyses were conducted using the maximum likelihood approach using Mark (White and Cooch Yr) through RMark (v.2.2.7, Laake 2013) in R Statistical environment (v.4.0.2, R Core Team). 

### Results

After grouping capture records within each season, capture histories from ```r ncol(data.CJS)``` seasons (occasions) were used in the analysis. The number of capture events within each season ranged from ```r min(effort.season$effort)``` to ```r max(effort.season$effort)```, whereas the number of turtles caught per season ranged from ```r min(colSums(CJS.data$data))``` to ```r max(colSums(CJS.data$data))```.   

There were ```r nrow(data.CJS)``` individuals in the capture records, where the maximum number of captures per individual was ```r max(rowSums(CJS.data$data))```.   

For this report, I use results from Mark because Bayesian analysis is taking a lot of time due to the large dataset.  Goodness-of-fit has been conducted and, although some questions remain as to the CJS model may not be perfect, in general, it is accepted.  

```{r GOF, echo=FALSE}
#CJS.data$data %>% rownames_to_column(var = "ID") -> CH.1 #data.CJS

# using R2ucare::group_data to combine CHs
CH.2 <- R2ucare::group_data(CJS.data$data, rep(1, nrow(CJS.data$data)))

# Need to do some GOF testing here.


```

The comparison of the models showed that one with transients effect on survival (phi(TSM)) and time-dependent capture probability (p(time)) was the best. 

```{r table_model_comparison, echo=FALSE, include=TRUE}
knitr::kable(mark.table.2, 
             digits = 2,
             caption = "Table 2. A comparison of 14 CJS models fitted to CMR data of green turtles. ",
             table.attr = "style='width:30%;'")
```

```{r prop_res, echo=FALSE}
p.residents <- cm.results$Phi.tsm.p.t$results$real$estimate[1]/cm.results$Phi.tsm.p.t$results$real$estimate[2]
p.residents.low <- cm.results$Phi.tsm.p.t$results$real$lcl[1]/cm.results$Phi.tsm.p.t$results$real$lcl[2]
p.residents.high <- cm.results$Phi.tsm.p.t$results$real$ucl[1]/cm.results$Phi.tsm.p.t$results$real$ucl[2]
```

The estimated survival rate of the residents was ```r signif(cm.results$Phi.tsm.p.t$results$real[2, "estimate"], 3)``` (SE = ```r signif(cm.results$Phi.tsm.p.t$results$real[2, "se"], 3)```, 95% CI = [```r signif(cm.results$Phi.tsm.p.t$results$real[2, "lcl"], 3)```, ```r signif(cm.results$Phi.tsm.p.t$results$real[2, "ucl"], 3)```]). Using the estimated two survival rates, the proportion of residents in the aggregation was computed to be ```r signif(p.residents, 3)``` (95% CI = ```r signif(p.residents.low, 3)``` - ```r signif(p.residents.high, 3)```). 

Abundance was computed from the estimated capture probability and the number of captured turtles per season using the Horvitz-Thompson estimator. 

```{r Nhats, echo=FALSE, include=F, cache=T}
phats <- cm.results$Phi.tsm.p.t$results$real[3:38, c("estimate", "lcl", "ucl")]
phats$season <- colnames(CJS.data$data)[2:(ncol(CJS.data$data))]

n.caught <- colSums(CJS.data$data)
Nhats.df <- data.frame(season = colnames(CJS.data$data)[2:(ncol(CJS.data$data))],
                       Nhat = (n.caught[2:length(n.caught)]/phats$estimate) * p.residents,
                       lcl  = (n.caught[2:length(n.caught)]/phats$lcl) * p.residents,
                       ucl = (n.caught[2:length(n.caught)]/phats$ucl) * p.residents)

p.Nhats <- ggplot(data = Nhats.df) +
  geom_point(aes(x = season, y = Nhat)) +
  geom_errorbar(aes(x = season, ymin = lcl, ymax = ucl)) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5)) +
  ylab("Abundance (95% CI)")

if (save.fig)
  ggsave(plot = p.Nhats, filename = "figures/Cm_Nhats.png",
         device = "png", dpi = 600)

```


```{r plot_Nhats, echo=FALSE, cache=TRUE, fig.cap="Figure 5. Estimated abundance of green turtles"}
knitr::include_graphics(paste0("figures/Cm_Nhats.png"))
```



