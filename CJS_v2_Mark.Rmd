---
title: "Capture recapture analyses for Agnese Mancini"
output: html_notebook
---

This document describes data analysis of Agnese Mancini's data of green turtle capture recapture events. 


Initialize the workspace
```{r}
rm(list=ls())
library(jagsUI)
library(tidyverse)
library(lubridate)
library(reshape)
library(bayesplot)
library(ggridges)
library(RMark)
library(R2ucare)

source("Mancini_functions.R")

do_analysis=function()
{
  # create formulas for Phi
  Phi.dot <-  list(formula=~1)  # easier and shorter names
  Phi.weight <- list(formula=~ weight)
  
  #create formulas for p
  p.dot <- list(formula=~1)
  p.time <- list(formula=~time)
  
  # create all combinations 
  cml <- create.model.list("CJS")
  
  # run all all 8 models and return as a list with class marklist
  results <- mark.wrapper(cml,
                          data=dp,
                          ddl=ddl,
                          output=FALSE,
                          silent=TRUE)
  return(results)
}

```

Bring in the data file and get ready for CJS

```{r warning=F}
dat.1 <- get.data("data/GTC_20190725_Tomo_v2.csv")

dat.1 %>% filter(species == "Cm") -> dat.2

CJS.data <- dat2CJS(dat.2, save.file = FALSE)
CJS.data$data %>% rownames_to_column(var = "ID") -> data.CJS

dat.2 %>% select(ID, weight_kg) %>% group_by(ID) %>%
  summarise(min_weight = min(weight_kg, na.rm = T)) %>%
  filter(!is.infinite(min_weight)) -> data.weight

data.weight  %>% left_join(data.CJS, by = "ID") %>%
  select(-c("ID", "min_weight")) -> CH.1

data.weight  %>% left_join(data.CJS, by = "ID") %>%
  select(min_weight) -> cov.weight

# capture history
tmp <- apply(as.matrix(CH.1), MARGIN = 2, FUN = paste0)
CH <- unite(data.frame(tmp), col = "ch", sep = "")
CH$min_weight <- cov.weight

# capture dates and difference in years
cap.dates <- paste0(colnames(CJS.data$data), "-01")
delta.dates <- as.numeric(as.Date(cap.dates[2:length(cap.dates)]) -
                            as.Date(cap.dates[1:(length(cap.dates)-1)]))/365

dp <- process.data(CH, model = "CJS", 
                   time.intervals = delta.dates)

# p(t) Phi(t)
ddl <- make.design.data(dp)
model <- mark(dp, ddl,
              output=FALSE,
              silent=TRUE)

summary(model)

```


```{r}
# p(t) Phi(dot)
Phi.dot <- list(formula = ~ 1)
model <- mark(dp, ddl,
              model.parameters = list(Phi = Phi.dot),
              output=FALSE,
              silent=TRUE)

summary(model)
```


```{r}
# p(t) Phi(min_weight)
Phi.weight <- list(formula = ~ min_weight)
model <- mark(dp, ddl,
              model.parameters = list(Phi = Phi.weight),
              output=FALSE,
              silent=TRUE)

summary(model)
```
